/*! m7-player - v0.0.1 - 2019-02-22
* COPYRIGHT (C) ZAO ALGONT , 2019*/

"use strict";function getUriParam(t){return(location.search.split(t+"=")[1]||"").split("&")[0]}function sendLog(){console.sendLog&&console.sendLog(arguments)}function toTranslit(t){return t.replace(/([а-яё])|([\s_-])|([^a-z\d])/gi,function(t,e,o,n,i){if(o||n)return o?"-":"";var r=e.charCodeAt(0);return["yo","a","b","v","g","d","e","zh","z","i","y","k","l","m","n","o","p","r","s","t","u","f","h","c","ch","sh","shch","","y","","e","yu","ya"][1025==r||1105==r?0:r>1071?r-1071:r-1039]})}function base64ToArrayBuffer(t){return Uint8Array.from(atob(t),function(t){return t.charCodeAt(0)})}function arrayBufferToBase64(t){for(var e="",o=new Uint8Array(t),n=o.byteLength,i=0;i<n;i++)e+=String.fromCharCode(o[i]);return window.btoa(e)}function getVideoContainerInfo(t){if(!t)return{};var e={},o=t.get(0);e.src=o.src;var n=t.closest(".divCell");if(n.length){e.cell={},e.cell.id=n.attr("id"),e.cell.streamid=n.attr("data-mediastreamid");var i=n.find(".titleContainer > a");i.length&&(e.cell.title=i.text())}return e}function getContainerInfo(t){if(!t)return{};var e={},o=t.closest(".divCell");if(o.length){e.id=o.attr("id"),e.streamid=o.attr("data-mediastreamid");var n=o.find(".titleContainer > a");n.length&&(e.title=n.html())}return e}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};!function(t,e,o,n){function i(e,o){this.$element=t(e),this.options=t.extend({},a,o),this.init()}var r=[].slice,a={baseRetryDelay:15,maxFluctuation:5};i.prototype={init:function(){this._active=!1},create:function(){var e=this;this.$element.find(".delay-start").length<1&&(e.$container=t("<div>").addClass("delay-start centerAbs").css({}).appendTo(e.$element),e.$timer=t("<div>").addClass("centerAbs delay-timer").hide().css({"font-size":"0.9em","line-height":"30px","font-weight":"bold"}).appendTo(e.$container),e.$spinner=t("<div>").addClass("centerAbs delay-spinner").hide().appendTo(e.$container),e.$container.append('<div class="camera-error"><span class="fa-stack fa-lg"><i class="fa fa-video-camera fa-stack-1x" style="color: white;"></i><i class="fa fa-ban fa-stack-2x" style="color: #a94442;"></i></span></div>'),t(".delay-timer, .delay-spinner").css({width:30,height:30}),e.$container.click(function(){console.log("click delay"),e.done()}))},show:function(t){console.log("Delay show");var e=this;this._active||(this._active=!0,this.create(),e.$container.show(),clearTimeout(e.randomTimeout),e.randomTimeout=setTimeout(function(){clearTimeout(e.randomTimeout),e.$spinner.show(),e.$timer.show(),e.delayReplayTimer=e.options.baseRetryDelay,e.$timer.html(e.delayReplayTimer),clearInterval(e.replayInterval),e.replayInterval=setInterval(function(){e.delayReplayTimer--,e.delayReplayTimer>0?e.$timer.html(e.delayReplayTimer):(clearInterval(e.replayInterval),e.delayReplayTimer=0,e.done())},1e3)},Math.floor(Math.random()*e.options.maxFluctuation*1e3)))},hide:function(){this._active&&(this.$container.hide(),this.$spinner.hide(),this.$timer.hide(),clearInterval(this.replayInterval),clearTimeout(this.randomTimeout),this._active=!1)},done:function(){this.hide(),console.log("Delay done!"),this.$element.trigger("m7PlayerDelayDone")},isActive:function(){return!0===this._active}},t.fn.delayStart=function(e){t.fn.delayStart.getters=["isActive"];var o=2<=arguments.length?r.call(arguments,1):[];if(void 0===e||"object"===(void 0===e?"undefined":_typeof(e)))return this.each(function(){t.data(this,"plugin-delayStart")||t.data(this,"plugin-delayStart",new i(this,e))});if("string"==typeof e&&"_"!==e[0]&&"init"!==e){if(0!==Array.prototype.slice.call(arguments,1).length||-1===t.inArray(e,t.fn.delayStart.getters))return this.each(function(){var n=t.data(this,"plugin-delayStart");n instanceof i&&"function"==typeof n[e]&&n[e].apply(n,o)});var n=t.data(this[0],"plugin-delayStart");if(n instanceof i&&"function"==typeof n[e])return n[e].apply(n,o)}}}(jQuery,window,document),function(t,e,o,n){function i(e,o){console.log("M7PlayerAframe 360 create"),this.$element=t(e),this.options=t.extend({},s,o);var n=this;this.$element.off(".m7PlayerAframe").on("m7PlayerCursorbtnClick.m7PlayerAframe",function(t,e){console.log("clicked",e),"home"===e?n.goHome():"left"===e?n.goLeft():"right"===e?n.goRight():"up"===e?n.goUp():"down"===e&&n.goDown()}),AFRAME.components["m7player-aframe-listener"]||(console.log("AFRAME.registerComponent m7player-aframe-listener"),AFRAME.registerComponent("m7player-aframe-listener",{init:function(){this.el.addEventListener("mousedown",this.handler.bind(this)),this.el.addEventListener("mouseup",this.handler.bind(this))},remove:function(){this.el.removeEventListener("mousedown",this.handler),this.el.removeEventListener("mouseup",this.handler)},handler:function(t){console.log("M7PlayerAframe event detected",t,this.el.camera,this.el.camera.el.getAttribute("rotation")),"mousedown"==t.type&&0==t.button?(this.myX=t.x,this.myY=t.y):"mouseup"==t.type&&0==t.button&&Math.abs(this.myX-t.x)<2&&Math.abs(this.myY-t.y)<2&&this.el.emit("m7PlayerClick",[t],!0)}}))}var r=[].slice,a="m7PlayerAframe",s={screenButtons:!0};i.prototype={create:function(){console.log("M7PlayerAframe 360 create");var e=this;if(this.$video=this.$element.find("video"),this.$video.length){this.$video.hasClass("aframed")&&this.destroy(),this.$video.addClass("aframed"),this.$video.attr("id")||this.$video.attr("id",Date.now());var o=t('<a-scene embedded vr-mode-ui="enabled: false" m7player-aframe-listener>');t('<a-camera id="camera" camera="active: true" look-controls="reverseMouseDrag: true"></a-camera>').appendTo(o);var n=t("<a-videosphere>");this.options.screenButtons&&this.$element.m7PlayerCursorbtn({}).m7PlayerCursorbtn("show"),n.attr("src","#"+this.$video.attr("id")).appendTo(o),this.$element.append(o),t("body").on("keydown.aframe",function(t){e.getCamera();console.log("keydown.aframe ",t.keyCode),72===t.keyCode?e.goHome():37===t.keyCode&&t.ctrlKey?e.goLeft():39===t.keyCode&&t.ctrlKey?e.goRight():38===t.keyCode&&t.ctrlKey?e.goUp():40===t.keyCode&&t.ctrlKey&&e.goDown()})}else console.error("M7PlayerAframe error: tag <video> not found!")},getCamera:function(){return t("#camera")[0]},goHome:function(){this.faceCameraToCoords({x:0,y:0,z:0})},goLeft:function(){this.relativeRotation({x:0,y:5,z:0})},goRight:function(){this.relativeRotation({x:0,y:-5,z:0})},goUp:function(){this.relativeRotation({x:5,y:0,z:0})},goDown:function(){this.relativeRotation({x:-5,y:0,z:0})},faceCameraToCoords:function(t){var e=this.getCamera();console.log("M7PlayerAframe faceCameraToCoords",t,e.getAttribute("rotation")),e.setAttribute("look-controls",{enabled:!1}),e.setAttribute("rotation",t);var o=e.object3D.rotation.x,n=e.object3D.rotation.y;e.components["look-controls"].pitchObject.rotation.x=o,e.components["look-controls"].yawObject.rotation.y=n,e.setAttribute("look-controls",{enabled:!0})},relativeRotation:function(t){var e=this.getCamera().getAttribute("rotation");this.faceCameraToCoords({x:e.x+t.x,y:e.y+t.y,z:e.z+t.z})},destroy:function(){console.log("M7PlayerAframe 360 destroy"),this.$element.find("a-scene").remove(),this.$video.removeClass("aframed"),this.$element.m7PlayerCursorbtn&&this.$element.m7PlayerCursorbtn("hide")},scale:function(t){console.log("M7PlayerAframe scale not implemented yet")}},t.fn[a]=function(e){t.fn[a].getters=[];var o=2<=arguments.length?r.call(arguments,1):[];if(void 0===e||"object"===(void 0===e?"undefined":_typeof(e)))return this.each(function(){t.data(this,"plugin-"+a)||t.data(this,"plugin-"+a,new i(this,e))});if("string"==typeof e&&"_"!==e[0]&&"init"!==e){if(0!==Array.prototype.slice.call(arguments,1).length||-1===t.inArray(e,t.fn[a].getters))return this.each(function(){var n=t.data(this,"plugin-"+a);n instanceof i&&"function"==typeof n[e]&&n[e].apply(n,o)});var n=t.data(this[0],"plugin-"+a);if(n instanceof i&&"function"==typeof n[e])return n[e].apply(n,o)}}}(jQuery,window,document),function(t,e,o,n){function i(e,o){console.log("m7PlayerAnalytics create"),this.$element=t(e),this.options=t.extend({},s,o);var n=this;n.canvasObjects={},this.$element.off("."+a).on("m7PlayerResize."+a,function(){n.prepare()}),this.init()}var r=[].slice,a="m7PlayerAnalytics",s={modules:{motionDetector:!0,faceDetector:!0,lpr:!0,CrossingLineDetector:!0,AbandonedObjectDetector:!0,CrowdDetector:!0,StartStopMotionDetector:!0,IntrusionDetector:!0},canvasRenderDelay:200};i.prototype={init:function(){this.prepare()},prepare:function(){console.log("m7PlayerAnalytics prepare");var e=this;this.$element.find(".analyticsCanvas").remove();var o=t("<canvas>").appendTo(this.$element);o.wrap('<div class="analyticsCanvas glass-layer">'),this.canvas=new fabric.StaticCanvas(o.get(0),{width:e.$element.width(),height:e.$element.height(),selection:!1,renderOnAddRemove:!1}),this.canvas.skipTargetFind=!0,this.canvas.selectable=!1},canvasDelayedRender:function(){var t=this;this.canvas&&!t.canvasRenderTimeout&&(t.canvasRenderTimeout=setTimeout(function(){t.canvas.renderAll(),t.canvasRenderTimeout=null},t.options.canvasRenderDelay))},background:function(t){var e=this;if(this.canvas||this.prepare(),t){var o=new fabric.Image(t,{left:0,top:0,width:e.$element.width(),height:e.$element.height(),originX:"left",originY:"top"});this.canvas.setBackgroundImage(o)}else this.canvas.backgroundImage=0,this.canvas.renderAll()},clear:function(){this.canvas&&this.canvas.clear()},getSnapshot:function(){return this.canvas.toDataURL({format:"jpeg"})},faceDetector:function(t){var e=this;this.face&&(clearTimeout(this.timeoutFaceHide),this.canvas.remove(this.face));var o=parseInt(e._getSimpleItemAttrValue(t,"operationTimeout"),10)||500,n=this._getRect(t,"tt:BoundingBox");n&&(this.face=new fabric.Rect({left:n.left,top:n.top,width:n.width,height:n.height,stroke:"#ff0",strokeWidth:2,fill:"rgba(0,0,0,0)",selectable:!1}),this.face.hasBorders=!1,this.canvas.add(this.face),e.canvasDelayedRender(),this.timeoutFaceHide=setTimeout(function(){e.face.remove(),delete e.face,e.canvasDelayedRender()},o))},hide:function(){console.log("m7PlayerAnalytics hide",new Date),this.clear()},lpr:function(t){var e=this;this.objLpr&&(clearTimeout(this.timeoutLpr),this.canvas.remove(this.objLpr));var o=this._getRect(t,"tt:BoundingBox");if(o){this.objLpr=new fabric.Rect({left:o.left,top:o.top,width:o.width,height:o.height,stroke:"#9900CC",strokeWidth:2,fill:"rgba(0,0,0,0)",selectable:!1}),this.objLpr.hasBorders=!1,this.canvas.add(this.objLpr),e.canvasDelayedRender();var n=parseInt(e._getSimpleItemAttrValue(t,"operationTimeout"),10)||500;this.timeoutLpr=setTimeout(function(){e.objLpr.remove(),delete e.objLpr,e.canvasDelayedRender()},n)}},AbandonedObjectDetector:function(t,e){console.log("AbandonedObjectDetector",t,e);var o=this,n=parseInt(o._getSimpleItemAttrValue(t,"operationTimeout"),10)||500,i=t.getElementsByTagName("tt:Zone")[0];if(i){var r=i.getAttribute("id");this["abandonedObject"+r]&&(clearTimeout(this["timeoutAbandonedObject"+r]),this.canvas.remove(this["abandonedObject"+r])),o["abandonedObject"+r]=new fabric.Group([],{left:0,top:0,width:o.canvas.width,height:o.canvas.height,originX:"left",originY:"top",selectable:!1});var a=this._getRect(t,"tt:Zone");if(a){console.log("AbandonedObjectDetector zone",a);var s=new fabric.Rect({left:a.left,top:a.top,width:a.width,height:a.height,stroke:"#CC0000",strokeWidth:1,fill:"rgba(225,225,225,0.2)",selectable:!1});s.hasBorders=!1,o["abandonedObject"+r].addWithUpdate(s);var l=this._getRect(t,"tt:BoundingBox");if(l){console.log("AbandonedObjectDetector boundingBox",l);var c=new fabric.Rect({left:l.left,top:l.top,width:l.width,height:l.height,stroke:"#CC6600",strokeWidth:2,fill:"rgba(0,0,0,0)",selectable:!1});c.hasBorders=!1,o["abandonedObject"+r].addWithUpdate(c),this.canvas.add(o["abandonedObject"+r]),o.canvasDelayedRender(),this["timeoutAbandonedObject"+r]=setTimeout(function(){o.canvas.remove(o["abandonedObject"+r]),delete o["abandonedObject"+r],o.canvasDelayedRender()},n)}}}},CrossingLineDetector:function(t,e){console.log("CrossingLineDetector",t,e);var o=this,n=t.getElementsByTagName("tt:Line")[0];if(n){var i=n.getAttribute("id");this["objCrossLine"+i]&&(clearTimeout(this["timeoutCrossLine"+i]),this.canvas.remove(this["objCrossLine"+i]));var r=parseInt(o._getSimpleItemAttrValue(t,"operationTimeout"),10)||500;if(o["objCrossLine"+i]=new fabric.Group([],{left:0,top:0,width:o.canvas.width,height:o.canvas.height,originX:"left",originY:"top",selectable:!1}),n=this._getLine(t)){console.log("CrossingLineDetector line",i,n);var a=new fabric.Line([n.left,n.top,n.right,n.bottom],{stroke:"#00DD00",strokeWidth:2,selectable:!1});a.hasBorders=!1,o["objCrossLine"+i].addWithUpdate(a);var s=this._getRect(t,"tt:BoundingBox");if(s){console.log("CrossingLineDetector boundingBox",i,s);var l=new fabric.Rect({left:s.left,top:s.top,width:s.width,height:s.height,stroke:"#CC0000",strokeWidth:2,fill:"rgba(0,0,0,0)",selectable:!1});l.hasBorders=!1,o["objCrossLine"+i].addWithUpdate(l),this.canvas.add(o["objCrossLine"+i]),o.canvasDelayedRender(),function(){var t=i;o["timeoutCrossLine"+t]=setTimeout(function(){o.canvas.remove(o["objCrossLine"+t]),delete o["objCrossLine"+t],o.canvasDelayedRender()},r)}()}}}},CrowdDetector:function(t,e){var o=this,n=o._getSimpleItemAttrValue(t,"alarm");if(n&&"0"!=n){console.log("CrowdDetector",t,e);var i=parseInt(o._getSimpleItemAttrValue(t,"operationTimeout"),10)||500,r=t.getElementsByTagName("tt:Object"),a=t.getElementsByTagName("tt:Scale")[0],s=t.getElementsByTagName("tt:Translate")[0];if(r){var l=!0,c=!1,d=void 0;try{for(var u,h=r[Symbol.iterator]();!(l=(u=h.next()).done);l=!0){var f=u.value,p=f.getAttribute("ObjectId");o.canvasObjects["crowdObject"+p]&&(clearTimeout(o["timeoutCrowdObject"+p]),o.canvas.remove(o.canvasObjects["crowdObject"+p])),o.canvasObjects["crowdObject"+p]=new fabric.Group([],{left:0,top:0,width:o.canvas.width,height:o.canvas.height,originX:"left",originY:"top",selectable:!1,hasControls:!1,hasBorders:!1,hasRotatingPoint:!1});var m=this._getRect(f,"tt:Zone",a,s),g=new fabric.Rect({left:m.left,top:m.top,width:m.width,height:m.height,stroke:"#FF0000",strokeWidth:1,fill:"rgba(0,0,0,0)",selectable:!1,hasControls:!1,hasBorders:!1,hasRotatingPoint:!1});g.hasBorders=!1,o.canvasObjects["crowdObject"+p].addWithUpdate(g);var y=this._getRect(f,"tt:BoundingBox",a,s),v=new fabric.Rect({left:y.left,top:y.top,width:y.width,height:y.height,stroke:"#FF6600",strokeWidth:2,fill:"rgba(0,0,0,0)",selectable:!1,hasControls:!1,hasBorders:!1,hasRotatingPoint:!1});v.hasBorders=!1,o.canvasObjects["crowdObject"+p].addWithUpdate(v),function(){var t=p;o["timeoutCrowdObject"+t]=setTimeout(function(){o.canvas.remove(o.canvasObjects["crowdObject"+t]),delete o.canvasObjects["crowdObject"+t],o.canvasDelayedRender()},i)}(),o.canvas.add(o.canvasObjects["crowdObject"+p])}}catch(t){c=!0,d=t}finally{try{!l&&h.return&&h.return()}finally{if(c)throw d}}o.canvasDelayedRender()}}},IntrusionDetector:function(t,e){var o=this,n=o._getSimpleItemAttrValue(t,"alarm");if(n&&"0"!=n){console.log("IntrusionDetector",t,e);var i=parseInt(o._getSimpleItemAttrValue(t,"operationTimeout"),10)||500,r=t.getElementsByTagName("tt:Object"),a=t.getElementsByTagName("tt:Scale")[0],s=t.getElementsByTagName("tt:Translate")[0];if(r){var l=!0,c=!1,d=void 0;try{for(var u,h=r[Symbol.iterator]();!(l=(u=h.next()).done);l=!0){var f=u.value,p=f.getAttribute("ObjectId");o.canvasObjects["intrusionObject"+p]&&(clearTimeout(o["timeoutIntrusionObject"+p]),o.canvas.remove(o.canvasObjects["intrusionObject"+p])),o.canvasObjects["intrusionObject"+p]=new fabric.Group([],{left:0,top:0,width:o.canvas.width,height:o.canvas.height,originX:"left",originY:"top",selectable:!1,hasControls:!1,hasBorders:!1,hasRotatingPoint:!1});var m=this._getRect(f,"tt:Zone",a,s),g=new fabric.Rect({left:m.left,top:m.top,width:m.width,height:m.height,stroke:"#FF0000",strokeWidth:1,fill:"rgba(0,0,0,0)",selectable:!1,hasControls:!1,hasBorders:!1,hasRotatingPoint:!1});g.hasBorders=!1,o.canvasObjects["intrusionObject"+p].addWithUpdate(g);var y=this._getRect(f,"tt:BoundingBox",a,s),v=new fabric.Rect({left:y.left,top:y.top,width:y.width,height:y.height,stroke:"#FF6600",strokeWidth:2,fill:"rgba(0,0,0,0)",selectable:!1,hasControls:!1,hasBorders:!1,hasRotatingPoint:!1});v.hasBorders=!1,o.canvasObjects["intrusionObject"+p].addWithUpdate(v),function(){var t=p;o["timeoutIntrusionObject"+t]=setTimeout(function(){o.canvas.remove(o.canvasObjects["intrusionObject"+t]),delete o.canvasObjects["intrusionObject"+t],o.canvasDelayedRender()},i)}(),o.canvas.add(o.canvasObjects["intrusionObject"+p])}}catch(t){c=!0,d=t}finally{try{!l&&h.return&&h.return()}finally{if(c)throw d}}o.canvasDelayedRender()}}},motionDetector:function(t,e){for(var o=this,n=t.getElementsByTagName("tt:MotionInCells")[0].getAttribute("Cells"),i=parseInt(t.getElementsByTagName("tt:MotionInCells")[0].getAttribute("Rows"),10)||1,r=parseInt(t.getElementsByTagName("tt:MotionInCells")[0].getAttribute("Columns"),10)||1,a=this._decodePackBits(this._base64ToArrayBuffer(n)),s="",l=0;l<a.length;l++){for(var c=a[l].toString(2);c.length<8;)c="0"+c;s+=c}var d=(this.canvas.width-2)/r,u=(this.canvas.height-2)/i;o["motionCells"+e]&&o.canvas.remove(o["motionCells"+e]),o["motionCells"+e]=new fabric.Group([],{left:0,top:0,width:o.canvas.width,height:o.canvas.height,originX:"left",originY:"top",selectable:!1});for(l=0;l<s.length;l++)if("1"===s[l]){var h=d*(l%r+1)-d,f=u*Math.floor(l/r),p=new fabric.Rect({width:d,height:u,left:h,top:f,stroke:"#0f0",strokeWidth:2,fill:"rgba(0,0,0,0)",originX:"left",originY:"top",hasBorders:!1});this["motionCells"+e].addWithUpdate(p)}this.canvas.add(o["motionCells"+e]),o.canvasDelayedRender()},StartStopMotionDetector:function(t,e){var o=this,n=o._getSimpleItemAttrValue(t,"alarm");if(n&&"0"!=n){console.log("StartStopMotionDetector",n,t,e);var i=parseInt(o._getSimpleItemAttrValue(t,"operationTimeout"),10)||500,r=t.getElementsByTagName("tt:Object"),a=t.getElementsByTagName("tt:Scale")[0],s=t.getElementsByTagName("tt:Translate")[0];if(r){var l=!0,c=!1,d=void 0;try{for(var u,h=r[Symbol.iterator]();!(l=(u=h.next()).done);l=!0){var f=u.value,p=f.getAttribute("ObjectId");o.canvasObjects["crowdObject"+p]&&(clearTimeout(o["timeoutCrowdObject"+p]),o.canvas.remove(o.canvasObjects["crowdObject"+p])),o.canvasObjects["crowdObject"+p]=new fabric.Group([],{left:0,top:0,width:o.canvas.width,height:o.canvas.height,originX:"left",originY:"top",selectable:!1,hasControls:!1,hasBorders:!1,hasRotatingPoint:!1});var m=this._getRect(f,"tt:Zone",a,s),g=new fabric.Rect({left:m.left,top:m.top,width:m.width,height:m.height,stroke:"#FF0000",strokeWidth:1,fill:"rgba(0,0,0,0)",selectable:!1,hasControls:!1,hasBorders:!1,hasRotatingPoint:!1});g.hasBorders=!1,o.canvasObjects["crowdObject"+p].addWithUpdate(g);var y=this._getRect(f,"tt:BoundingBox",a,s),v=new fabric.Rect({left:y.left,top:y.top,width:y.width,height:y.height,stroke:"#FF6600",strokeWidth:2,fill:"rgba(0,0,0,0)",selectable:!1,hasControls:!1,hasBorders:!1,hasRotatingPoint:!1});v.hasBorders=!1,o.canvasObjects["crowdObject"+p].addWithUpdate(v),function(){var t=p;o["timeoutCrowdObject"+t]=setTimeout(function(){o.canvas.remove(o.canvasObjects["crowdObject"+t]),delete o.canvasObjects["crowdObject"+t],o.canvasDelayedRender()},i)}(),o.canvas.add(o.canvasObjects["crowdObject"+p])}}catch(t){c=!0,d=t}finally{try{!l&&h.return&&h.return()}finally{if(c)throw d}}o.canvasDelayedRender()}}},show:function(t){this.$element.find(".analyticsCanvas").length||(console.log("M7PlayerAnalytics need prepare() on show() :("),this.prepare());var e=t.metadata;try{for(var o,n,i=(new DOMParser).parseFromString(e,"text/xml"),r=i.getElementsByTagName("tt:SimpleItem"),a=0;a<r.length;a++)"software"===r[a].getAttribute("Value")?(o=r[a].getAttribute("Name"),n="software"):"hardware"===r[a].getAttribute("Value")?(o=r[a].getAttribute("Name"),n="hardware"):"vit"===r[a].getAttribute("Value")&&(o=r[a].getAttribute("Name"),n="vit");o?"function"!=typeof this[o]?console.error("m7PlayerAnalytics.show error. Unsupported type of analytics: "+o,this[o]):this.options.modules[o]&&this[o](i,n):console.error("m7PlayerAnalytics.show error. Unknown type of analytics",e)}catch(t){console.error("parse error",t,e)}},stateModule:function(t,e){var o=1==e||"SHOW"==e;"function"==typeof this[modules]?this.options.modules=o:console.error("m7PlayerAnalytics.stateModule: unknown module "+t)},_getRect:function(t,e,o,n){var i=this,r=i.$element.width(),a=i.$element.height(),s=t.getElementsByTagName(e)[0];if(console.log("_getRect",s,e,t),s){var l=parseInt(s.getAttribute("left"),10),c=parseInt(s.getAttribute("top"),10),d=parseInt(s.getAttribute("right"),10),u=parseInt(s.getAttribute("bottom"),10),h=o||t.getElementsByTagName("tt:Scale")[0];if(h){var f=parseFloat(h.getAttribute("x"),10),p=parseFloat(h.getAttribute("y"),10),m=n||t.getElementsByTagName("tt:Translate")[0];if(m){var g,y,v,w,b=r/2,k=a/2,$=b+parseFloat(m.getAttribute("x"),10)*b,C=k-parseFloat(m.getAttribute("y"),10)*k,P=r/Math.abs(2/f),T=a/Math.abs(2/p),S=l*P,M=c*T,A=d*P,I=u*T;return g=f>0?$+S:$-(r-S),y=p>0?C-(a-M):C+M,v=r-A-S,w=a-M-I,{left:g,top:y,width:v,height:w}}}}},_getLine:function(t){var e=this,o=e.$element.width(),n=e.$element.height(),i=t.getElementsByTagName("tt:Line")[0];if(i){var r=parseInt(i.getAttribute("left"),10),a=parseInt(i.getAttribute("top"),10),s=parseInt(i.getAttribute("right"),10),l=parseInt(i.getAttribute("bottom"),10),c=t.getElementsByTagName("tt:Scale")[0];if(c){var d=parseFloat(c.getAttribute("x"),10),u=parseFloat(c.getAttribute("y"),10),h=t.getElementsByTagName("tt:Translate")[0];if(h){var f,p,m,g,y=o/2,v=n/2,w=y+parseFloat(h.getAttribute("x"),10)*y,b=v-parseFloat(h.getAttribute("y"),10)*v,k=o/Math.abs(2/d),$=n/Math.abs(2/u),C=r*k,P=a*$,T=s*k,S=l*$;return d>0?(f=w+C,m=o-(w+T)):(f=w-(o-C),m=o-(w-(o-T))),u>0?(p=b-(n-P),g=n-(b-(n-S))):(p=b+P,g=n-(b+S)),{left:f,top:p,right:m,bottom:g}}}}},_getSimpleItemAttrValue:function(t,e){for(var o=t.getElementsByTagName("tt:SimpleItem"),n=0;n<o.length;n++)if(o[n].getAttribute("Name")===e)return o[n].getAttribute("Value");return!1},_base64ToArrayBuffer:function(t){return Int8Array.from(atob(t),function(t){return t.charCodeAt(0)})},_decodePackBits:function(t){for(var e=new Uint8Array(t.length),o=0,n=0,i=t.length;o<i;){var r=t[o];if(o++,r>=0&&r<128)for(a=0;a<r+1;a++)e[n]=t[o],n++,o++;if(r>=-127&&r<0){for(var a=0;a<1-r;a++)e[n]=t[o],n++;o++}}return e}},t.fn[a]=function(e){t.fn[a].getters=["getSnapshot"];var o=2<=arguments.length?r.call(arguments,1):[];if(void 0===e||"object"===(void 0===e?"undefined":_typeof(e)))return this.each(function(){t.data(this,"plugin-"+a)||t.data(this,"plugin-"+a,new i(this,e))});if("string"==typeof e&&"_"!==e[0]&&"init"!==e){if(0!==Array.prototype.slice.call(arguments,1).length||-1===t.inArray(e,t.fn[a].getters))return this.each(function(){var n=t.data(this,"plugin-"+a);n instanceof i&&"function"==typeof n[e]&&n[e].apply(n,o)});var n=t.data(this[0],"plugin-"+a);if(n instanceof i&&"function"==typeof n[e])return n[e].apply(n,o)}}}(jQuery,window,document),function(t,e,o,n){function i(e,o){this.$element=t(e),this.options=t.extend({},s,o),this.init()}var r=[].slice,a="m7PlayerCursorbtn",s={};i.prototype={init:function(){},show:function(){var e=this;this.buttonsContainer=t('<div class="cursor-buttons-container">'),this.cursorButtons=t('<div class="cursor-buttons">'),t('<i class="fa fa-home home-button cursor-button" data-id="home">').appendTo(this.cursorButtons),t('<i class="fa fa-chevron-left left-button cursor-button" data-id="left">').appendTo(this.cursorButtons),t('<i class="fa fa-chevron-right right-button cursor-button" data-id="right">').appendTo(this.cursorButtons),t('<i class="fa fa-chevron-up up-button cursor-button" data-id="up">').appendTo(this.cursorButtons),t('<i class="fa fa-chevron-down down-button cursor-button" data-id="down">').appendTo(this.cursorButtons),this.cursorButtons.appendTo(this.buttonsContainer),this.$element.append(this.buttonsContainer),this.cursorButtons.on("mousedown",function(o){e.$element.trigger("m7PlayerCursorbtnClick",[t(o.target).data("id")]),e.interval=setInterval(function(){e.$element.trigger("m7PlayerCursorbtnClick",[t(o.target).data("id")])},100)}).on("mouseup mouseleave",function(t){e.interval&&(clearInterval(e.interval),delete e.interval)})},hide:function(){this.buttonsContainer.remove()}},t.fn[a]=function(e){t.fn[a].getters=[];var o=2<=arguments.length?r.call(arguments,1):[];if(void 0===e||"object"===(void 0===e?"undefined":_typeof(e)))return this.each(function(){t.data(this,"plugin-"+a)||t.data(this,"plugin-"+a,new i(this,e))});if("string"==typeof e&&"_"!==e[0]&&"init"!==e){if(0!==Array.prototype.slice.call(arguments,1).length||-1===t.inArray(e,t.fn[a].getters))return this.each(function(){var n=t.data(this,"plugin-"+a);n instanceof i&&"function"==typeof n[e]&&n[e].apply(n,o)});var n=t.data(this[0],"plugin-"+a);if(n instanceof i&&"function"==typeof n[e])return n[e].apply(n,o)}}}(jQuery,window,document),function(t,e,o,n){function i(e,o){this.shift=0,this.hasAudio=!1,this.$element=t(e),this.$player=this.$element.hasClass("m7Player")?this.$element:this.$element.closest(".m7Player"),this.options=t.extend({},s,o),this.$video=t("<video>").addClass("m7PlayerHtml5"),this.options.autoplay&&this.$video.attr("autoplay","autoplay"),this.$element.html(this.$video),this.$video.attr({crossorigin:"anonymous"}),this.video=this.$video.get(0),this.init()}var r=[].slice,a="m7PlayerHtml5",s={playbackRate:1,autoplay:!1,cache:0,controls:!1,debugRegim:!1,delayControl:0,mode:"stable",stalledTimeout:3e3,view360:!1,workersCount:1};i.prototype={init:function(){console.log("M7PlayerHtml5 init");var t=this;this.video.controls=this.options.controls,this.video.preload="none",this.$video.off().on("mousedown."+a,function(e){console.log("mousedown",e),0==e.button&&(t.myMouseDownX=e.pageX,t.myMouseDownY=e.pageY)}).on("mouseup."+a,function(e){console.log("mouseup",t,e),0==e.button&&Math.abs(t.myMouseDownX-e.pageX)<2&&Math.abs(t.myMouseDownY-e.pageY)<2&&(t.$element.trigger("m7PlayerClick",[e]),delete t.myMouseDownX,delete t.myMouseDownY)}).on("loadstart."+a,function(t){console.log("video loadstart")}).on("progress."+a,function(e){var o=t.getBufferInfo();o&&t.$element.trigger("m7BufferChange",[o])}).on("suspend."+a,function(e){sendLog("on video suspend",getVideoContainerInfo(t.$video)),console.log("video suspend")}).on("abort."+a,function(e){console.log("video abort"),sendLog("on video abort",getVideoContainerInfo(t.$video))}).on("emptied."+a,function(e){console.log("video emptied"),sendLog("on video emptied",getVideoContainerInfo(t.$video))}).on("stalled."+a,function(e){console.log("video stalled"),sendLog("on video stalled",getVideoContainerInfo(t.$video)),t.options.stalledTimeout&&!t.stalledTimeout&&(t.stalledTimeout=setTimeout(function(){sendLog("**error on video stalled",getVideoContainerInfo(t.$video)),t.$element.trigger("m7PlayerError","error on video stalled"),t.stalledTimeout=null},t.options.stalledTimeout))}).on("loadedmetadata."+a,function(e){console.log("video loadedmetadata",t.video.textTracks),t.track&&(t.track.oncuechange=null,console.log("set track oncuechange=null metadata ")),t.track=this.addTextTrack("metadata"),console.log("set track oncuechange metadata 3",t.track),t.track.oncuechange=function(){t._onCueChange(t.track,!0)}}).on("loadeddata."+a,function(e){console.log("video loadeddata");var o=!1;void 0!==t.video.webkitAudioDecodedByteCount?t.video.webkitAudioDecodedByteCount>0&&(o=!0):void 0!==t.video.mozHasAudio?t.video.mozHasAudio&&(o=!0):console.error("can't tell if video has audio"),t.$video.trigger("m7StreamHasAudioReceived",[o])}).on("canplay."+a,function(e){console.log("video canplay",{audioTracks:t.video.audioTracks}),sendLog("on video canplay",{paused:t.video.paused},getVideoContainerInfo(t.$video)),!0!==t.video.ended&&(!0===t.manualPaused?t.pause():t.play())}).on("canplaythrough."+a,function(e){console.log("video canplaythrough"),sendLog("on video canplaythrough",getVideoContainerInfo(t.$video))}).on("waiting."+a,function(e){console.log("video waiting"),sendLog("on video waiting",getVideoContainerInfo(t.$video)),t.options.stalledTimeout&&!t.stalledTimeout&&(t.stalledTimeout=setTimeout(function(){sendLog("**error on video waiting",getVideoContainerInfo(t.$video)),t.$element.trigger("m7PlayerError","error on video waiting"),t.stalledTimeout=null},t.options.stalledTimeout))}).on("seeking."+a,function(e){console.log("video seeking"),sendLog("on video seeking",getVideoContainerInfo(t.$video))}).on("seeked."+a,function(e){console.log("video seeked"),sendLog("on video seeked",getVideoContainerInfo(t.$video))}).on("ended."+a,function(e){console.log("video ended"),sendLog("on video ended",getVideoContainerInfo(t.$video)),t.$element.trigger("m7PlayerEndReached")}).on("durationchange."+a,function(t){console.log("video durationchange",this.duration)}).on("timeupdate."+a,function(e){if(t.$element.trigger("m7PlayerTimeChange",[this.currentTime,t.getDelay(),this.duration]),t.track)t.track.activeCues;t.stalledTimeout&&(clearTimeout(t.stalledTimeout),delete t.stalledTimeout)}).on("play."+a,function(e){console.log("video play"),sendLog("on video play",{paused:t.video.paused},getVideoContainerInfo(t.$video)),console.log("video play"),t.manualPaused=!1,clearTimeout(t.stalledTimeout),delete t.stalledTimeout,t.$element.trigger("m7PlayerPlay"),t.requestStreamInfo()}).on("playing."+a,function(e){console.log("video playing"),t.$element.trigger("m7PlayerPlaying"),t.stalledTimeout&&(clearTimeout(t.stalledTimeout),delete t.stalledTimeout)}).on("pause."+a,function(e){console.log("video pause"),t.$element.trigger("m7PlayerPause"),sendLog("on video pause",getVideoContainerInfo(t.$video)),t.stalledTimeout&&(clearTimeout(t.stalledTimeout),delete t.stalledTimeout)}).on("ratechange."+a,function(e){t.$element.trigger("m7PlayerRateChange",[t.video.playbackRate])}).on("resize."+a,function(e){console.log("video resize",t.video.videoWidth,t.video.videoHeight),t.$element.trigger("m7PlayerResolution",[t.video.videoWidth,t.video.videoHeight])}).on("volumechange."+a,function(e,o){console.log("video volumechange",e,o),t.$element.trigger("m7PlayerVolumeChange",[t.video.volume,t.video.muted])}).on("error."+a,function(e){console.error("video error",e),sendLog("** player error",{paused:t.video.paused},getVideoContainerInfo(t.$video)),t.$element.trigger("m7PlayerError","video hrml5 error"),t.stalledTimeout&&(clearTimeout(t.stalledTimeout),delete t.stalledTimeout)}).on("m7MetadataReceived."+a,function(e,o,n){i=parseFloat(n)-parseFloat(t.shift);if(console.log("M7PlayerHtml5 m7MetadataReceived",{currentTime:t.video.currentTime,timestamp:n,shift:t.shift,start:i,track:t.track}),t.track){var i=parseFloat(n)-parseFloat(t.shift),r=new VTTCue(i,i+.2,o);console.log("set track oncuechange metadata 2",t.track.cues?t.track.cues.length:0),t.track.addCue(r)}}).on("m7StreamHasAudioReceived."+a,function(e,o){console.log("m7StreamHasAudioReceived",o),t.hasAudio=o,t.$element.trigger("m7PlayerVolumeChange",[t.video.volume,t.video.muted])}).on("m7StreamTimeShiftReceived."+a,function(e,o){t.shiftReceivedTime=new Date,console.log("m7StreamTimeShiftReceived",o,t.shiftReceivedTime),t.shift=o})},addMetadata:function(e){var o=this;if("vtt"==e.type||"text/vtt"==e.mimeType){if(e.file){var n=t("<track>").attr({label:"metadata",kind:"metadata",src:e.file,default:"default"}).appendTo(this.$video).get(0).track;console.log("track vtt added. set track oncuechange metadata",n),n.oncuechange=function(){o._onCueChange(n,!1)}}}else console.error("Unsupported metadata type: ",e)},destroy:function(){this.$video.remove(),this.$element.removeData("plugin-"+a)},clear:function(){sendLog("html5 clear",getVideoContainerInfo(this.$video)),this.$video.html(""),this.video.pause(),this.video.src="",this.clearCues(),this.$video.videoMSE&&this.$video.videoMSE("reset")},clearCues:function(){if(console.log("m7PlayerHtml5.clearCues start"),this.$video.find("track").remove(),this.track){if(this.track.cues)for(;this.track.cues.length;)this.track.removeCue(this.track.cues[0]);delete this.track}},hide:function(){this.$video.hide()},isAudioAvailable:function(){return console.log("m7PlayerHtml5.isAudioAvailable",this.hasAudio),1==this.hasAudio},mute:function(t){if(void 0===t)return this.video.muted;this.video.muted=1==t},nextFrame:function(){this.video.currentTime+=1/15},src:function(t){if(console.log("m7PlayerHtml5 src",t),void 0===t||""==t)return this.options.src;this.options.src=t,this.$video.find("source").remove(),this.clearCues(),"string"==typeof t?this.video.src=t:(t.video&&t.video.uri&&(t.src=t.src||t.video.uri),t.src&&(t.view360=t.view360||!1,this.options.view360!=t.view360&&this.view360(t.view360),this.video.removeAttribute("src"),"algont/mse2"==t.mime?this.$video.videoMSE2({mode:this.options.mode,cache:this.options.cache,workersCount:this.options.workersCount}).videoMSE2("src",t):"algont/mse"==t.mime?this.$video.videoMSE({mode:this.options.mode,cache:this.options.cache,workersCount:this.options.workersCount}).videoMSE("src",t):"algont/mse3"==t.mime?this.$video.videoMseNoWorkers({mode:this.options.mode}).videoMseNoWorkers("src",t):"algont/mse4"==t.mime?this.$video.videoMseNoWorkers2({mode:this.options.mode,src:t}):"synology/mse"==t.mime?this.$video.synologyMSE({mode:this.options.mode}).synologyMSE("src",t):this.video.src=t.src)),this.playbackRate(this.options.playbackRate)},play:function(){console.log("m7player-html5 play"),sendLog("video play",getVideoContainerInfo(this.$video)),this.video.play()},pause:function(){console.log("m7player-html5 pause"),sendLog("video pause",getVideoContainerInfo(this.$video)),this.manualPaused=!0,this.$element.trigger("m7PlayerPause"),this.video.pause()},show:function(){this.$video.show()},stop:function(){console.log("m7player-html5 pause"),this.video.pause()},getSnapshot:function(){return console.log("getSnapshot, analytics",this.$player.m7Player("analytics")),this.$player.m7Player("analytics")?this._getSnapshotAnalytics():this._getSnapshot()},_getSnapshot:function(){console.log("_getSnapshot");var e=t("<canvas>").css({width:this.video.videoWidth,height:this.video.videoHeight}).appendTo(this.$element),o=e.get(0);o.width=this.video.videoWidth,o.height=this.video.videoHeight,e.get(0).getContext("2d").drawImage(this.video,0,0,o.width,o.height);var n=o.toDataURL("image/jpeg");return e.remove(),n},_getSnapshotAnalytics:function(){console.log("_getSnapshotAnalytics"),this.$element.m7PlayerAnalytics("background",this.video);var t=this.$element.m7PlayerAnalytics("getSnapshot");return this.$element.m7PlayerAnalytics("background",""),t},playbackRate:function(t){this.video.playbackRate=t},position:function(t){if(!t)return this.video.currentTime;console.log("m7playar-html5 set position",t),this.video.currentTime=t},requestStreamInfo:function(){this.$element.trigger("m7StreamInfo",{width:this.video.videoWidth,height:this.video.videoHeight})},rewind:function(t){this.video.currentTime+=t},rewindToEnd:function(t){this.video.buffered.length&&this.video.buffered.end(this.video.buffered.length-1)-this.video.currentTime>.2&&(this.video.currentTime=this.video.buffered.end(this.video.buffered.length-1)-.1)},getTimeShift:function(){return this.shift},getDelay:function(){return this.video.buffered.length?this.video.buffered.end(this.video.buffered.length-1)-this.video.currentTime:0},getBufferInfo:function(){if(this.video.buffered.length)try{var t=Math.round(1e3*(this.video.buffered.end(this.video.buffered.length-1)-this.video.currentTime))/1e3;this.historyBuffer=this.historyBuffer||[],this.historyBuffer.push(t),this.historyBuffer.length>30&&this.historyBuffer.shift();var e={fromEndOfBuffer:t,minBuffer:Math.min.apply(null,this.historyBuffer),bufferedLength:this.video.buffered.length,bufferedStart:this.video.buffered.start(this.video.buffered.length-1),bufferedEnd:this.video.buffered.end(this.video.buffered.length-1)};return this.track&&(e.cuesLength=this.track.cues?this.track.cues.length:0),e}catch(t){return}},getPlaybackQuality:function(){var t={};return this.video.getVideoPlaybackQuality?this.video.getVideoPlaybackQuality():(this.video.webkitDecodedFrameCount&&(t.webkitDecodedFrameCount=this.video.webkitDecodedFrameCount),this.video.webkitDroppedFrameCount&&(t.webkitDroppedFrameCount=this.video.webkitDroppedFrameCount),this.video.webkitVideoDecodedByteCount&&(t.webkitVideoDecodedByteCount=this.video.webkitVideoDecodedByteCount),this.video.webkitAudioDecodedByteCount&&(t.webkitAudioDecodedByteCount=this.video.webkitAudioDecodedByteCount),Object.keys(t).length?t:void 0)},view360:function(t){if(void 0===t)return this.options.view360;console.log("view360()",t);var e=this.$element;this.options.view360=t,this.options.view360?(e.addClass("fullsize"),e.m7PlayerAframe({}).m7PlayerAframe("create")):(e.m7PlayerAframe&&e.m7PlayerAframe("destroy"),e.removeClass("fullsize"))},volume:function(t){if(void 0===t)return this.video.volume;this.video.volume=t,this.mute(!1)},_onCueChange:function(t,e){console.log("metadata track oncuechange",t);for(var o=0,n=0;n<t.activeCues.length;n++)this.$element.trigger("m7PlayerMetadataEvent",[t.activeCues[n].text,t.activeCues[n].id]),o=t.activeCues[n].startTime,e&&t.removeCue(t.activeCues[n]);if(e&&o&&t.cues&&t.cues.length)for(var i=0;i<t.cues.length;)t.cues[i]&&t.cues[i].startTime<o?t.removeCue(t.cues[i]):i++}},t.fn[a]=function(e){t.fn[a].getters=["src","getTimeShift","getPlaybackQuality","getBufferInfo","getSnapshot","_getSnapshot","_getSnapshotAnalytics","isAudioAvailable","mute","volume","view360","position"];var o=2<=arguments.length?r.call(arguments,1):[];if(void 0===e||"object"===(void 0===e?"undefined":_typeof(e)))return this.each(function(){t.data(this,"plugin-"+a)||t.data(this,"plugin-"+a,new i(this,e))});if("string"==typeof e&&"_"!==e[0]&&"init"!==e){if(0!==Array.prototype.slice.call(arguments,1).length||-1===t.inArray(e,t.fn[a].getters))return this.each(function(){var n=t.data(this,"plugin-"+a);n instanceof i&&"function"==typeof n[e]&&n[e].apply(n,o)});var n=t.data(this[0],"plugin-"+a);if(n instanceof i&&"function"==typeof n[e])return n[e].apply(n,o)}}}(jQuery,window,document),function(t,e,o,n){function i(e,o){this.$element=t(e),this.$player=this.$element.hasClass("m7Player")?this.$element:this.$element.closest(".m7Player"),this.options=t.extend({},s,o),this.init()}var r=[].slice,a="m7PlayerInfo",s={strings:{resolution:"Разрешение",errors:"Переподключений"}};i.prototype={init:function(){this.$infoPane=null,console.log("m7PlayerInfo init")},show:function(){var e=this;e.hide(),e.$infoPane=t("<div>").addClass("stream-info").appendTo(e.$player),e.$resolution=t("<div>").append(e.options.strings.resolution+": <span></span>").appendTo(e.$infoPane).find("span"),e.$errors=t("<div>").append(e.options.strings.errors+": <span>"+e.$player.m7Player("getErrorsCount")+"</span>").appendTo(e.$infoPane).find("span"),e.$element.on("m7StreamInfo."+a,function(t,o){console.log("M7PlayerInfo on m7StreamInfo",o),e.$resolution.html(o.width+"x"+o.height)}).on("M7PlayerEncounteredError."+a,function(t,o){console.log("M7PlayerInfo on playerEncounteredError",o),e.$errors.html(o)}),e.$player.m7Player("requestStreamInfo")},hide:function(){this.$element.off("."+a),this.$player.find(".stream-info").remove(),this.$infoPane=null},toggle:function(){this.$infoPane?this.hide():this.show()},state:function(t){if(void 0===t||""===t)return null!=this.$infoPane;1==t?this.show():this.hide()}},t.fn[a]=function(e){t.fn[a].getters=["state"];var o=2<=arguments.length?r.call(arguments,1):[];if(void 0===e||"object"===(void 0===e?"undefined":_typeof(e)))return this.each(function(){t.data(this,"plugin-"+a)||t.data(this,"plugin-"+a,new i(this,e))});if("string"==typeof e&&"_"!==e[0]&&"init"!==e){if(0!==Array.prototype.slice.call(arguments,1).length||-1===t.inArray(e,t.fn[a].getters))return this.each(function(){var n=t.data(this,"plugin-"+a);n instanceof i&&"function"==typeof n[e]&&n[e].apply(n,o)});var n=t.data(this[0],"plugin-"+a);if(n instanceof i&&"function"==typeof n[e])return n[e].apply(n,o)}}}(jQuery,window,document),function(t,e,o,n){function i(e,o){this.$element=t(e),this.options=t.extend({},s,o),this.init()}var r=[].slice,a="m7PlayerMjpeg",s={};i.prototype={init:function(){},src:function(e){if(console.log("M7PlayerMjpeg src",e),void 0===e||""==e)return this.$element[this.options.engine]("src");"string"==typeof e?this.source=e:e.src?this.source=e.src:console.error("M7PlayerMjpeg error: source not defined!"),this.source&&(this.hide(),t("<img>").addClass("M7PlayerMjpeg").attr("src",this.source).css({position:"absolute",top:0,left:0,width:"100%",height:"100%"}).appendTo(this.$element),this.$element.trigger("directMjpegRegim",["on"]))},hide:function(){this.$element.trigger("directMjpegRegim",["off"]),this.$element.find(".M7PlayerMjpeg").remove()}},t.fn[a]=function(e){t.fn[a].getters=["src"];var o=2<=arguments.length?r.call(arguments,1):[];if(void 0===e||"object"===(void 0===e?"undefined":_typeof(e)))return this.each(function(){t.data(this,"plugin-"+a)||t.data(this,"plugin-"+a,new i(this,e))});if("string"==typeof e&&"_"!==e[0]&&"init"!==e){if(0!==Array.prototype.slice.call(arguments,1).length||-1===t.inArray(e,t.fn[a].getters))return this.each(function(){var n=t.data(this,"plugin-"+a);n instanceof i&&"function"==typeof n[e]&&n[e].apply(n,o)});var n=t.data(this[0],"plugin-"+a);if(n instanceof i&&"function"==typeof n[e])return n[e].apply(n,o)}}}(jQuery,window,document),function(t,e,o,n){function i(e,o){this.$element=t(e),this.options=t.extend({},s,o),this.init()}var r=[].slice,a="m7PlayerPlaybtn",s={state:"play",iconSize:80};i.prototype={init:function(){var t=this;console.log("m7PlayerPlaybtn init"),t.$element.on("m7PlayerStateChange."+a,function(e,o){t.options.state="play"==o?"pause":"play",t.setButton(t.options.state)})},show:function(){var e=this;e.$playBtnControl&&e.$playBtnControl.off().remove(),e.$playBtnControl=t("<div>").addClass("play-btn centerAbs").addClass("visibleOnHover").css({overflow:"hidden",opacity:"0.6","text-align":"center",margin:"auto",height:200,"z-index":111}).appendTo(e.$element),e.$playBtnControl.click(function(){var t;(t=e.$playBtnControl.find("i"))&&("function"==typeof t.effect?t.effect("puff",{},500,function(){e.onClick()}):e.onClick())}),"pause"==e.options.state?e.setButton("pause"):"play"==e.options.state?e.setButton("play"):e.$playBtnControl.html(""),e.$playBtnControl.on("mouseover",function(){e.$playBtnControl.find("i").css("display","inherit")})},onClick:function(t){this.$element.trigger("m7PlayerPlaybtnClick",[this.options.state])},setButton:function(e){var o="pause"==e?"fa-pause":"fa-play-circle-o",n=this,i=t("<i>").addClass("fa "+o).css({color:"white","font-size":n.options.iconSize,opacity:"0.6",width:n.options.iconSize});n.$playBtnControl.html(i),"function"==typeof i.effect?i.css("position","absolute").position({of:n.$playBtnControl}):i.addClass("centerAbs").css("line-height","200px")}},t.fn[a]=function(e){t.fn[a].getters=[];var o=2<=arguments.length?r.call(arguments,1):[];if(void 0===e||"object"===(void 0===e?"undefined":_typeof(e)))return this.each(function(){t.data(this,"plugin-"+a)||t.data(this,"plugin-"+a,new i(this,e))});if("string"==typeof e&&"_"!==e[0]&&"init"!==e){if(0!==Array.prototype.slice.call(arguments,1).length||-1===t.inArray(e,t.fn[a].getters))return this.each(function(){var n=t.data(this,"plugin-"+a);n instanceof i&&"function"==typeof n[e]&&n[e].apply(n,o)});var n=t.data(this[0],"plugin-"+a);if(n instanceof i&&"function"==typeof n[e])return n[e].apply(n,o)}}}(jQuery,window,document),function(t,e,o,n){function i(e,o){this.$element=t(e),this.options=t.extend({},a,o),this.options.active=!1,this.init()}var r=[].slice,a={ptzNode:{}};i.prototype={init:function(){console.log("M7PlayerPtz init");var t=this;this.$element.on("mouseup",function(e){t.options.active&&(console.log("M7PlayerPtz click mouseup"),t._mouseup(e))}).on("click",function(t){t.preventDefault(),t.stopPropagation()}).on("mousedown",function(e){t.options.active&&(console.log("M7PlayerPtz click mousedown"),t._mousedown(e))}).on("mousemove",function(e){t.options.active&&t._mousemove(e)})},active:function(e){if(void 0===e)return this.options.active;if(this.options.active=1==e,console.log("M7PlayerPtz active",this.options.active),this.options.active){if(this.options.ptzNode.centerPanTiltSupport){var o=t("<div>").addClass("centerGlass text-center").css({position:"absolute"});t("<span>").css({color:"red","font-size":"24px","text-shadow":"#000 1px 1px 1px"}).append("+").appendTo(o),this.$element.html("").append(o),o.position({of:this.$element})}this.options.ptzNode.centerPanTiltSupport||this.options.ptzNode.absoluteZoomPositionSupport?this.$element.css("cursor","crosshair"):this.options.ptzNode.relativePanTiltTranslationSupport&&(this.$element.html(""),this.$element.css("cursor","pointer"))}else this.$element.html(""),this.$element.css("cursor","inherit");return this.options.active=1==e,this.$element},ptzNode:function(e){return void 0===e?this.options.ptzNode:(this.options.ptzNode=t.extend({},a.ptzNode,e),this.$element)},_sendZoomboxEvent:function(){var t=this.$element.find(".m7-zoombox");t.length>0&&(this.$element.trigger("ptzZoom",{x:t.position().top,y:t.position().left,width:t.width(),height:t.height()}),delete this.x,delete this.y)},_makeZoombox:function(t,e){console.log("_makeZoombox"),this._deleteZoombox(),this.$element.append('<div class="m7-zoombox"></div>').find(".m7-zoombox").css({top:Math.min(this.y,e),left:Math.min(this.x,t),width:Math.abs(this.x-t),height:Math.abs(this.y-e)})},_deleteZoombox:function(){console.log("_deleteZoombox"),t(".m7-zoombox").remove()},_makeZoomboxCenter:function(e,o){this._deleteZoombox(),console.log("_makeZoomboxCenter");var n,i,r,a,s=2*Math.abs(this.x-e),l=2*Math.abs(this.y-o),c=this.x-s/2,d=this.y-l/2,u=this.$element.width()/this.$element.height();s>l*u?(r=s,n=c,i=d-((a=s/u)-l)/2):(a=l,i=d,n=c-((r=l*u)-s)/2),t("<div>").addClass("m7-zoombox").css({top:Math.round(i),left:Math.round(n),width:Math.round(r),height:Math.round(a),"z-index":100}).appendTo(this.$element)},_sendZoomboxCenterEvent:function(){console.log("_sendZoomboxCenterEvent");var t=this.$element.find(".m7-zoombox");t.length>0&&(this.$element.trigger("ptzZoomCenter",{x:t.position().left+t.width()/2,y:t.position().top+t.height()/2,zoomFactor:this.$element.width()/t.width(),width:this.$element.width(),height:this.$element.height()}),delete this.x,delete this.y,this._deleteZoombox())},_mousedown:function(t){this._mousePressed=!0;var e=t.pageX-this.$element.offset().left,o=t.pageY-this.$element.offset().top,n=this;this._deleteZoombox(),console.log("mouse down: "+e+", "+o),n.x=e,n.y=o},_mouseup:function(e){var o=this;this._mousePressed=!1;var n=e.pageX-this.$element.offset().left,i=e.pageY-this.$element.offset().top;if(console.log({func:"ptz click mouseup",event:e}),t(".m7-zoombox").length>0)o._sendZoomboxCenterEvent();else if(this.options.ptzNode.centerPanTiltSupport)clearTimeout(this.mouseDownTimeout),0==this.$element.find(".m7-zoombox").length&&(this.$element.trigger("ptzCenter",{x:n,y:i,width:this.$element.width(),height:this.$element.height()}),delete this.x,delete this.y);else if(this.options.ptzNode.relativeZoomTranslationSupport&&void 0!==this.x&&void 0!==this.y&&this.x!==n&&this.y!==i)console.log("ZoomboxEvent second point: "+n+", "+i),this._makeZoombox(n,i),this._sendZoomboxEvent();else if(this.options.ptzNode.relativePanTiltTranslationSupport){clearTimeout(this.mouseDownTimeout),delete this.mouseDownTimeout;var r=(n-this.$element.width()/2)/this.$element.width(),a=(this.$element.height()/2-i)/this.$element.height();console.log("ptzMove"),this.$element.trigger("ptzMove",{shiftX:r,shiftY:a})}else console.log("Unsupported operation")},_mousemove:function(t){if(this.$element.trigger("playerMouseMove",t),this._mousePressed){var e=t.pageX-this.$element.offset().left,o=t.pageY-this.$element.offset().top;this.options.ptzNode.areaZoom?void 0!==this.x&&void 0!==this.y&&e!==this.x&&o!==this.y&&this._makeZoomboxCenter(e,o):this.options.ptzNode.relativeZoomTranslationSupport&&void 0!==this.x&&void 0!==this.y&&this._makeZoombox(e,o)}}},t.fn.m7PlayerPtz=function(e){t.fn.m7PlayerPtz.getters=["active","ptzNode"];var o=2<=arguments.length?r.call(arguments,1):[];if(void 0===e||"object"===(void 0===e?"undefined":_typeof(e)))return this.each(function(){t.data(this,"plugin-m7PlayerPtz")||t.data(this,"plugin-m7PlayerPtz",new i(this,e))});if("string"==typeof e&&"_"!==e[0]&&"init"!==e){if(0!==Array.prototype.slice.call(arguments,1).length||-1===t.inArray(e,t.fn.m7PlayerPtz.getters))return this.each(function(){var n=t.data(this,"plugin-m7PlayerPtz");n instanceof i&&"function"==typeof n[e]&&n[e].apply(n,o)});var n=t.data(this[0],"plugin-m7PlayerPtz");if(n instanceof i&&"function"==typeof n[e])return n[e].apply(n,o)}}}(jQuery,window,document),function(t,e,o,n){function i(e,o){this.$element=t(e),this.options=t.extend({},s,o),this.init()}var r=[].slice,a="m7PlayerSimple",s={};i.prototype={init:function(){}},t.fn[a]=function(e){t.fn[a].getters=[];var o=2<=arguments.length?r.call(arguments,1):[];if(void 0===e||"object"===(void 0===e?"undefined":_typeof(e)))return this.each(function(){t.data(this,"plugin-"+a)||t.data(this,"plugin-"+a,new i(this,e))});if("string"==typeof e&&"_"!==e[0]&&"init"!==e){if(0!==Array.prototype.slice.call(arguments,1).length||-1===t.inArray(e,t.fn[a].getters))return this.each(function(){var n=t.data(this,"plugin-"+a);n instanceof i&&"function"==typeof n[e]&&n[e].apply(n,o)});var n=t.data(this[0],"plugin-"+a);if(n instanceof i&&"function"==typeof n[e])return n[e].apply(n,o)}}}(jQuery,window,document),function(t,e,o,n){function i(e,o){this.$element=t(e),this.$player=this.$element.hasClass("m7Player")?this.$element:this.$element.closest(".m7Player"),this.options=t.extend({},s,o),this.init()}var r=[].slice,a="m7PlayerTechinfo",s={frequency:1e3};i.prototype={init:function(){this.$debugPane=null,console.log("m7PlayerTechinfo init")},show:function(){var e=this;e.hide(),t("<div>").addClass("tech-info glass-layer overlay").css({background:"black",opacity:.6,padding:6}).appendTo(e.$element),e.$debugPane=t("<div>").addClass("tech-info glass-layer overlay").css({color:"#00ff00",padding:6}).appendTo(e.$element),e.updateInfo(),e.$player.on("m7PlayerTimeChange."+a,function(t,o,n){e.debugInfo.currentTime=o}).on("m7DelayChange."+a,function(t,o,n,i){e.debugInfo.delay=o,e.debugInfo.correctionsCount=n,e.debugInfo.lastRewindToEnd=i}).on("m7PlayerQueueChanged."+a,function(t,o){e.debugInfo.queue=o}).on("m7PlayerMseStatus."+a,function(t,o){e.debugInfo.mse="u.start: "+o.updatestart+" u: "+o.update+" u.end: "+o.updateend+" err: "+o.error+" abort: "+o.abort})},hide:function(){this.$element.off("."+a),this.$element.find(".tech-info").remove(),this.$debugPane=null,this.debugInfo={}},state:function(t){if(void 0===t||""===t)return null!=this.$debugPane;1==t?this.show():this.hide()},toggle:function(){this.$debugPane?this.hide():this.show()},updateInfo:function(){var t=this;if(this.$debugPane){var e="";if(t.debugInfo.currentTime){var o=Math.round(1e3*t.debugInfo.currentTime)/1e3||0;moment&&(o+=" - "+moment(new Date-1e3*t.debugInfo.currentTime).fromNow());var n=t.$player.m7Player("getLastErrorMessage");n&&(o+=" ("+n+")"),e+="<div>currentTime: "+o+"</div>"}var i=t.debugInfo.correctionsCount||0;t.debugInfo.lastRewindToEnd&&(i+=", последняя была "+moment(t.debugInfo.lastRewindToEnd).fromNow()),e+="<div>Коррекций: "+i+"</div>",t.debugInfo.mse&&(e+="<div>MSE: "+t.debugInfo.mse+"</div>");var r=t.$player.m7Player("getBufferInfo");if(console.log("getBufferInfo",r),r)for(var a in r)e+="<div>"+a+": "+r[a]+"</div>";var s=t.$player.m7Player("getPlaybackQuality");if(s)for(var a in s)e+="<div>"+a+": "+s[a]+"</div>";this.$debugPane.html(e),setTimeout(function(){t.updateInfo()},t.options.frequency)}}},t.fn[a]=function(e){t.fn[a].getters=["state"];var o=2<=arguments.length?r.call(arguments,1):[];if(void 0===e||"object"===(void 0===e?"undefined":_typeof(e)))return this.each(function(){t.data(this,"plugin-"+a)||t.data(this,"plugin-"+a,new i(this,e))});if("string"==typeof e&&"_"!==e[0]&&"init"!==e){if(0!==Array.prototype.slice.call(arguments,1).length||-1===t.inArray(e,t.fn[a].getters))return this.each(function(){var n=t.data(this,"plugin-"+a);n instanceof i&&"function"==typeof n[e]&&n[e].apply(n,o)});var n=t.data(this[0],"plugin-"+a);if(n instanceof i&&"function"==typeof n[e])return n[e].apply(n,o)}}}(jQuery,window,document),function(t,e,o,n){function i(e,o){this.$element=t(e),this.info=getContainerInfo(this.$element),this.options=t.extend({},s,o),this.init()}var r=[].slice,a="m7PlayerTitleTemp",s={duration:5e3};i.prototype={init:function(){this.titlePane=null,console.log("m7PlayerTitleTemp init",this.info)},show:function(){"function"==typeof this.$element.m7PlayerTitle&&this.$element.m7PlayerTitle("state")||(console.log("m7PlayerTitleTemp show"),this.info=getContainerInfo(this.$element),this.info.title&&(this.hide(),t("<div>").addClass("title-info").css({top:0,left:0}).html(this.info.title).appendTo(this.$element),this.options.duration&&(this.timeoutHide=setTimeout(function(t){t.hide()},this.options.duration,this)),this.titlePane=!0))},hide:function(){clearTimeout(this.timeoutHide),this.$element.find(".title-info").remove(),this.titlePane=null}},t.fn[a]=function(e){t.fn[a].getters=["state"];var o=2<=arguments.length?r.call(arguments,1):[];if(void 0===e||"object"===(void 0===e?"undefined":_typeof(e)))return this.each(function(){t.data(this,"plugin-"+a)||t.data(this,"plugin-"+a,new i(this,e))});if("string"==typeof e&&"_"!==e[0]&&"init"!==e){if(0!==Array.prototype.slice.call(arguments,1).length||-1===t.inArray(e,t.fn[a].getters))return this.each(function(){var n=t.data(this,"plugin-"+a);n instanceof i&&"function"==typeof n[e]&&n[e].apply(n,o)});var n=t.data(this[0],"plugin-"+a);if(n instanceof i&&"function"==typeof n[e])return n[e].apply(n,o)}}}(jQuery,window,document),function(t,e,o,n){function i(e,o){this.$element=t(e),this.info=getContainerInfo(this.$element),this.options=t.extend({},s,o),this.init()}var r=[].slice,a="m7PlayerTitle",s={};i.prototype={init:function(){this.$titlePane=null,console.log("m7PlayerTitle init",this.info)},show:function(){"function"==typeof this.$element.m7PlayerTitleTemp&&this.$element.m7PlayerTitleTemp("hide"),console.log("m7PlayerTitle show"),this.info=getContainerInfo(this.$element),this.hide(),t("<div>").addClass("title-info").css({top:0,left:0}).html(this.info.title).appendTo(this.$element),t("<div>").addClass("title-info").css({bottom:0,right:0,color:"#ffffff"}).html("#"+this.info.streamid).appendTo(this.$element),this.$titlePane=!0},hide:function(){this.$element.find(".title-info").remove(),this.$titlePane=null},state:function(t){if(console.log("m7PlayerTitle state",t),void 0===t||""===t)return null!=this.$titlePane;1==t?this.show():this.hide()},toggle:function(){this.$titlePane?this.hide():this.show()}},t.fn[a]=function(e){t.fn[a].getters=["state"];var o=2<=arguments.length?r.call(arguments,1):[];if(void 0===e||"object"===(void 0===e?"undefined":_typeof(e)))return this.each(function(){t.data(this,"plugin-"+a)||t.data(this,"plugin-"+a,new i(this,e))});if("string"==typeof e&&"_"!==e[0]&&"init"!==e){if(0!==Array.prototype.slice.call(arguments,1).length||-1===t.inArray(e,t.fn[a].getters))return this.each(function(){var n=t.data(this,"plugin-"+a);n instanceof i&&"function"==typeof n[e]&&n[e].apply(n,o)});var n=t.data(this[0],"plugin-"+a);if(n instanceof i&&"function"==typeof n[e])return n[e].apply(n,o)}}}(jQuery,window,document),function(t,e,o,n){function i(e,o){this.$element=t(e),this.options=t.extend({},s,o),this.init()}var r=[].slice,a="m7PlayerWatchdog",s={debug:!1,timeout:3e3,maxDelay:2.5};i.prototype={init:function(){console.log("m7PlayerWatchdog.init",this.options),this.start()},start:function(){this.stop(),this.pid=setTimeout(function(t){t.check()},this.options.timeout,this)},stop:function(){this.pid&&(clearTimeout(this.pid),delete this.pid)},check:function(){console.log("m7PlayerWatchdog.check");try{t(".m7Player").m7Player("checkAlive")}catch(t){console.error("m7PlayerWatchdog.check error",t)}this.start()}},t.fn[a]=function(e){t.fn[a].getters=[];var o=2<=arguments.length?r.call(arguments,1):[];if(void 0===e||"object"===(void 0===e?"undefined":_typeof(e)))return this.each(function(){t.data(this,"plugin-"+a)||t.data(this,"plugin-"+a,new i(this,e))});if("string"==typeof e&&"_"!==e[0]&&"init"!==e){if(0!==Array.prototype.slice.call(arguments,1).length||-1===t.inArray(e,t.fn[a].getters))return this.each(function(){var n=t.data(this,"plugin-"+a);n instanceof i&&"function"==typeof n[e]&&n[e].apply(n,o)});var n=t.data(this[0],"plugin-"+a);if(n instanceof i&&"function"==typeof n[e])return n[e].apply(n,o)}}}(jQuery,window,document),function(t,e,o,n){function i(e,o){console.log("M7Player create",o),this.options=t.extend(!0,{},a,o),this.options.cache=getUriParam("cache")||this.options.cache,this.options.debugRegim=getUriParam("debugRegim")||this.options.debugRegim,this.options.workersCount=getUriParam("workersCount")||this.options.workersCount,this.options.stalledTimeout=getUriParam("waitingTimeout")||this.options.stalledTimeout,this.options.wrongSocket=getUriParam("wrongSocket")||!1,this.$elementContainer=t(e),this.$elementContainer.addClass("m7Player"),this.options.backgroundColor&&this.$elementContainer.css({backgroundColor:this.options.backgroundColor}),this.$elementContainer.off(),this.$elementContainer.find(".m7PlayerVideoContainer").off(),this.$element=t("<div>").addClass("m7PlayerVideoContainer");do{this.playerSelector="id"+(new Date).getTime()}while(t(".m7Player."+this.playerSelector).length>0);this.$elementContainer.addClass(this.playerSelector),this.$elementContainer.attr("data-id",this.playerSelector),this.$elementContainer.html(this.$element),this.init(),this.lastDelayStart=new Date,this.lastErrorMessage="",this.errorsCount=0,this.delayCount=0,this.lastErrorMessage="",this._state}var r=[].slice,a={alignVideoX:"center",alignVideoY:"center",analytics:!1,autoplay:!1,baseRetryDelay:15,cache:0,clickControl:!1,clickControlAnimation:"clicked",controls:!1,debugRegim:!1,delayControl:0,engine:"m7PlayerHtml5",fastReconnect:!0,maxDelay:0,maxFluctuation:3,mode:"stable",muted:!1,playBtn:!1,playbackRate:1,playlist:[],playlistCurrentItem:-1,retryOnError:!0,retryCallback:null,src:"",stalledTimeout:3e3,statistics:!1,timeoutToHideChannelName:5e3,volume:1,watchdogTimeout:0,wheelZoomable:!1,workersCount:1,zoomCutMode:!1};i.prototype={init:function(){console.log("M7Player init",this.options);var e=this;this.state("init"),this.fullscreenState=!1,this.lastRewindToEnd=0,this.aspectRatio,e.watchdog(!0),t(o).on("mozfullscreenchange.M7Player webkitfullscreenchange.M7Player fullscreenchange.M7Player",function(t){var n=o.fullScreen||o.mozFullScreen||o.webkitIsFullScreen,i=e.$elementContainer.parent();!n&&i.hasClass("m7-fullscreen")&&e.fullscreen(!1)}),e.$elementContainer.off(".m7Player").on("contextmenu.M7Player",function(t){console.log("click contextmenu"),t.preventDefault(),t.stopPropagation()}).on("click.M7Player",function(){console.log("click player",e.$elementContainer),e.$elementContainer.trigger("playerClick")}).on("m7PlayerDelayDone.M7Player",function(){if(e.state("start"),sendLog("m7PlayerDelayDone.M7Player",getVideoContainerInfo(e.$video)),console.log("m7PlayerDelayDone.M7Player",e.options.retryCallback),"function"==typeof e.options.retryCallback){var t=e.options.retryCallback();"function"==typeof e[t]&&e[t]()}else e.src(e.options.src),e.play()}),this.$element.off(".m7Player").on("m7PlayerClick.M7Player",function(t){e.options.clickControl&&e.togglePlay(!0)}).on("m7PlayerTimeChange.M7Player",function(t,o,n,i){var r=new Date;e.playStart||(e.playStart=r-1e3*o),e.currentTime=o;var a=Math.round(r-e.playStart-1e3*o)/1e3;a!=e.delay&&(e.delay=a,e.$element.trigger("m7DelayChange",[a,e.delayCorrections,e.lastRewindToEnd])),e.$elementContainer.trigger("playerTimeChanged",[1e3*o,e.options.playlistCurrentItem])}).on("m7PlayerPlay.M7Player",function(t){console.log("m7PlayerPlay"),e.playStart=0,e.state("play"),e.$elementContainer.trigger("playerPlaying")}).on("m7PlayerPlaying.M7Player",function(t){console.log("m7PlayerPlaying"),e.$elementContainer.removeClass("error-video"),sendLog("m7PlayerPlaying",getVideoContainerInfo(e.$video)),e.delayCount=0,e.show()}).on("m7PlayerPause.M7Player",function(t){console.log("m7PlayerPause"),e.state("pause"),e.$elementContainer.trigger("playerPaused")}).on("m7PlayerResolution.M7Player",function(t,o,n){console.log("m7PlayerResolution",o,n),e.stream=e.stream||{};var i=e.stream.width!=o||e.stream.height!=n;e.stream.width=o,e.stream.height=n,i&&e.resetZoom()}).on("m7PlayerResize.M7Player",function(t,o,n){e.analytics(e.options.analytics)}).on("m7PlayerVolumeChange",function(t,o,n){console.log("m7PlayerVolumeChange",{volume:o,mute:n}),e.$elementContainer.trigger("volumeChanged",[n,o])}).on("m7PlayerStateChange",function(t,e){}).on("m7PlayerEndReached.M7Player",function(t){console.log("m7PlayerEndReached",e.options.playlistCurrentItem,e.options.playlist.length),e.options.playlistCurrentItem+1>=e.options.playlist.length?e.$elementContainer.trigger("playerEndReached"):(e.playlistItemLoad(e.options.playlistCurrentItem+1),e.play())}).on("m7PlayerRateChange.M7Player",function(t,o){console.log("m7PlayerRateChange",o),e.options.playbackRate=o}).on("m7BufferChange",function(t,o){var n=new Date;o.fromEndOfBuffer<-1?(console.log("Strange fromEndOfBuffer",o),e.buffControl?(e.buffControl.bufferedEnd==o.bufferedEnd?e.buffControl.count++:(e.buffControl.count=1,e.buffControl.bufferedEnd=o.bufferedEnd),e.buffControl.count>3&&(e.buffControl=null,console.log("Strange fromEndOfBuffer - m7PlayerError"),e.$element.trigger("m7PlayerError","Strange fromEndOfBuffer"))):e.buffControl={count:1,bufferedEnd:o.bufferedEnd},sendLog("Strange fromEndOfBuffer",o.fromEndOfBuffer,getVideoContainerInfo(e.$video))):(e.buffControl=null,e.options.delayControl&&o.fromEndOfBuffer&&o.fromEndOfBuffer>e.options.delayControl&&n-e.lastRewindToEnd>15e3&&(console.log("Start correction",{now:n,fromEndOfBuffer:o.fromEndOfBuffer,delayControl:e.options.delayControl}),e.rewindToEnd(),e.play()))}).on("m7PlayerError.M7Player",function(t,o){e.watchdog(!1),console.error("m7PlayerError",o,t),e.lastErrorMessage=o||"",sendLog("m7PlayerError",getVideoContainerInfo(e.$video)),e.delayStart()}).on("m7PlayerMetadataEvent.M7Player",function(t,o,n){e.options.analytics&&e.$element.m7PlayerAnalytics("show",{metadata:o,num:n})}).on("mousewheel DOMMouseScroll",function(t){if(e.options.wheelZoomable&&!t.ctrlKey&!t.shiftKey)return e.$element.find("a-scene").length?e.$element.m7PlayerAframe("scale",t):e.wheelZoom(t),!1}),this.options.analytics&&this.analytics(!0),this.options.src&&this.src(this.options.src)},addMetadata:function(t){console.log("addMetadata",t),this.$element[this.options.engine]("addMetadata",t)},addToPlaylist:function(t){this.options.playlist.push(t),""==this.options.src&&this.playlistItemLoad(0),console.log("addToPlaylist",t,this.options.playlist)},analytics:function(t){if(void 0===t||""===t)return 1==this.options.analytics;this.options.analytics=1==t,this.options.analytics?this.$element.m7PlayerAnalytics({}):"function"==typeof this.$element.m7PlayerAnalytics&&this.$element.m7PlayerAnalytics("hide"),this.checkAnalytics()},analyticsShowType:function(t,e){this.$element.m7PlayerAnalytics({}).m7PlayerAnalytics("stateModule",{module:t,state:e})},animAction:function(e){this.$elementContainer.find(".anim-action").remove(),"play"==e?t("<div>").addClass("anim-action img-play centerAbs").appendTo(this.$elementContainer).animate({opacity:0},{step:function(e,o){var n=1-e+1;t(this).css("transform","scale("+n+")")},duration:600,always:function(){t(this).remove()}}):"pause"==e&&t("<div>").addClass("anim-action img-pause centerAbs").appendTo(this.$elementContainer).animate({opacity:0},{step:function(e,o){var n=1-e+1;t(this).css("transform","scale("+n+")")},duration:600,always:function(){t(this).remove()}})},checkAlive:function(){if(this.options.watchdogTimeout&&this.options.src){console.log("M7Player.checkAlive",this.playerSelector),this.lastState=this.lastState||{frames:0,position:-1,positionCountRetry:0};var t=this.getPlaybackQuality(),e=!1;if(t){var o=t.totalVideoFrames||t.webkitDecodedFrameCount||0;if(console.log("M7Player.checkAlive frames=",o,this.lastState.frames),o==this.lastState.frames)if(this.lastState.wasRewindToEnd)if(0==o||this.lastState.countRetry>2)this.lastState.wasRewindToEnd=!1,this.testError("frames freeze, watchdog"),console.log("M7Player.checkAlive frames stalled: sended error",this.playerSelector),e=!0;else{var n=this.lastState.countRetry||0;this.lastState.countRetry=n+1,e=!0,console.log("M7Player.checkAlive frames stalled: +1 countRetry",this.playerSelector,n)}else this.rewindToEnd(),this.lastState.wasRewindToEnd=!0,console.log("M7Player.checkAlive frames stalled: rewindToEnd",this.playerSelector),e=!0;else this.lastState.frames=o,this.lastState.countRetry=0}else console.log("M7Player.checkAlive NO quality",this.playerSelector);if(!e&&this.position()>300){var i=new Date-this.getLastRewindToEnd();if(i>6e5*(Math.random()+1)){var r=this.getBufferInfo();r&&r.minBuffer>.4&&(console.log("M7Player.checkAlive tuning rewindToEnd",{timeFromLastRewindToEnd:i,bufferInfo:r}),this.rewindToEnd())}}else console.log("M7Player.checkAlive position() < 300",this.position());e||this.position()!=this.lastState.position?(this.lastState.positionCountRetry=0,this.lastState.position=this.position()):++this.lastState.positionCountRetry>2&&(this.lastState.positionCountRetry=0,console.log("M7Player.checkAlive position stopped ",this.position()),this.testError("position stopped"),e=!0)}},checkAnalytics:function(){console.log("M7Player.checkAnalytics",this.options.analytics),this.options.analytics?this.$element.trigger("analyticsChanged",["on"]):this.$element.trigger("analyticsChanged",["off"])},checkStatistics:function(){console.log("M7Player.checkStatistics",this.options.statistics),this.options.statistics?this.$element.trigger("statisticsChanged",["on"]):this.$element.trigger("statisticsChanged",["off"])},clear:function(){console.log("M7Player.clear"),this.delayStop(),this.delay=0,this.delayCorrections=0,this.lastRewindToEnd=0,this.$element[this.options.engine]("clear"),"function"==typeof this.$element.m7PlayerAnalytics&&this.$element.m7PlayerAnalytics("clear"),this.$element[this.options.engine]&&this.$element[this.options.engine]("destroy")},clearPlaylist:function(){this.pause(),this.options.playlist=[],this.options.playlistItem=-1,this.options.src=""},debugInfo:function(t){var e=this.$elementContainer.m7PlayerTechinfo({}).m7PlayerTechinfo("state");if(void 0===t||""===t)return e;this.$elementContainer.m7PlayerTechinfo({}).m7PlayerTechinfo("state",t)},delayStart:function(){console.log("M7Player.delayStart",this.options.src);var t=this;if(t.$elementContainer.m7PlayerTitleTemp({duration:t.options.timeoutToHideChannelName}).m7PlayerTitleTemp("show"),"function"==typeof this.$element.m7PlayerAnalytics&&this.$element.m7PlayerAnalytics("clear"),t.options.retryOnError){var e=new Date,o=e-this.lastDelayStart;sendLog("run delayStart",{fastReconnect:this.options.fastReconnect,delayCount:this.delayCount,timeFromLastDelay:o,condition:this.options.fastReconnect&&0===this.delayCount&&o>3e4},getVideoContainerInfo(t.$video)),this.options.fastReconnect&&0===this.delayCount&&o>15e3?(t.state("delayStart"),this.errorsCount++,this.delayCount++,sendLog("try fast reconnect",{errorsCount:this.errorsCount},getVideoContainerInfo(t.$video)),this.$elementContainer.trigger("m7PlayerDelayDone"),this.lastDelayStart=e):"delayStart"!=t.state()&&(t.hideVideo(),t.$elementContainer.addClass("error-video"),sendLog("try delay reconnect",{fastReconnect:this.options.fastReconnect,delayCount:this.delayCount,timeFromLastDelay:o},getVideoContainerInfo(t.$video)),t.state("delayStart"),this.lastDelayStart=e,t.errorsCount++,this.delayCount++,t.$element.trigger("M7PlayerEncounteredError",t.errorsCount),t.$elementContainer.delayStart({baseRetryDelay:t.options.baseRetryDelay,maxFluctuation:t.options.maxFluctuation}).delayStart("show"))}},delayStop:function(){this.$elementContainer.delayStart&&this.$elementContainer.delayStart({baseRetryDelay:this.options.baseRetryDelay,maxFluctuation:this.options.maxFluctuation}).delayStart("hide")},destroy:function(){console.log("M7Player destroy"),this.clear(),this.$elementContainer.removeData("plugin-m7Player"),this.$element.html("")},draggable:function(t){var e=this;this.$element.draggable&&(t?this.$element.draggable({}).on("drag",function(t,o){console.log("on drag");var n=o.position.left-o.originalPosition.left;n>0?o.position.left>0&&(o.position.left=0):e.$elementContainer.width()-e.$element.width()>o.position.left&&(o.position.left=e.$elementContainer.width()-e.$element.width()),(n=o.position.top-o.originalPosition.top)>0?o.position.top>0&&(o.position.top=0):e.$elementContainer.height()-e.$element.height()>o.position.top&&(o.position.top=e.$elementContainer.height()-e.$element.height())}):this.$element.draggable({}).draggable("destroy"))},getBufferInfo:function(){var t=this.$element[this.options.engine]("getBufferInfo");return"object"==(void 0===t?"undefined":_typeof(t))&&t.context?void 0:t},getDelay:function(){return this.delay},getErrorsCount:function(){return this.errorsCount},getLastErrorMessage:function(){return this.lastErrorMessage},getLastRewindToEnd:function(){return this.lastRewindToEnd},getPlaybackQuality:function(){var t=this.$element[this.options.engine]("getPlaybackQuality");return"object"==(void 0===t?"undefined":_typeof(t))&&t.context?void 0:t},getSnapshot:function(){var t=this.$element[this.options.engine]("getSnapshot");return("object"!=(void 0===t?"undefined":_typeof(t))||!t.context)&&t},getTimeShift:function(){console.log("m7 getTimeShift");var t=this.$element[this.options.engine]("getTimeShift");return"object"==(void 0===t?"undefined":_typeof(t))&&t.context?void 0:t},fillContainer:function(){var t=this,e=t.$elementContainer.width(),o=t.$elementContainer.height();if(console.log("fillContainer",t.stream,e,o),!t.stream.width||!t.stream.height)return t;var n=t.stream.width/t.stream.height,i=e/t.stream.width,r=o/t.stream.height;i>r?(this.origWidth=e,this.resizePlayer(e,t.stream.height*i)):(this.origWidth=t.stream.width*r,this.resizePlayer(t.stream.width*r,o)),t.$element.position({my:t.options.alignVideoX+" "+t.options.alignVideoY,at:t.options.alignVideoX+" "+t.options.alignVideoY,of:t.$elementContainer}),t.aspectRatio=n,this.draggable(!0),this.$elementContainer.find(".normalZoom").remove()},fitPlayerToContainer:function(){var t=this,e=t.$elementContainer.width(),o=t.$elementContainer.height();if(console.log("fitPlayerToContainer",t.stream,e,o),!t.stream.width||!t.stream.height)return t;var n=t.stream.width/t.stream.height,i=e/t.stream.width,r=o/t.stream.height;i<r?(this.origWidth=e,this.resizePlayer(e,t.stream.height*i)):(this.origWidth=t.stream.width*r,this.resizePlayer(t.stream.width*r,o)),t.$element.position({my:t.options.alignVideoX+" "+t.options.alignVideoY,at:t.options.alignVideoX+" "+t.options.alignVideoY,of:t.$elementContainer}),t.aspectRatio=n,this.draggable(!1),this.$elementContainer.find(".normalZoom").remove(),this.options.zoomCutMode=!1},fullscreen:function(t){if(void 0===t)return this.fullscreenState;this.fullscreenState=1==t;var e=this.$elementContainer.parent();this.fullscreenState?e.addClass("m7-fullscreen"):e.removeClass("m7-fullscreen"),console.log("fullscreen",this.fullscreenState),this.onresize()},hide:function(){this.hideVideo()},hideVideo:function(){this.$element[this.options.engine]("hide")},isAudioAvailable:function(){var t=this.$element[this.options.engine]("isAudioAvailable");return console.log("m7Player.isAudioAvailable",t),t},isVisible:function(){return"hidden"!=this.$element.css("visibility")},mute:function(t){if(void 0===t)return this.$element[this.options.engine]("mute");console.log("m7Player mute",t),this.$element[this.options.engine]("mute",1==t)},nextFrame:function(){this.$element[this.options.engine]("nextFrame")},onresize:function(){var t=this,e=t.$elementContainer.width(),o=t.$elementContainer.height();t.resetZoom(),clearTimeout(t.resizeTimeout),t.resizeTimeout=setTimeout(function(){e!=t.$elementContainer.width()||o!=t.$elementContainer.height()?t.onresize():t.$element.trigger("m7PlayerFullscreenChange")},100)},pause:function(t){sendLog("m7-player pause State="+this.state(),getVideoContainerInfo(this.$video)),console.log("try to pause. State="+this.state()),this.$element[this.options.engine]("pause"),("always"==this.options.clickControlAnimation||"clicked"==this.options.clickControlAnimation&&t&&t.clickedOnPlayer)&&this.animAction("pause")},play:function(t){console.log("m7Player play",t,this.options.playlist);var e=this;t?(this.options&&("always"==this.options.clickControlAnimation||"clicked"==this.options.clickControlAnimation&&t&&t.clickedOnPlayer)&&this.animAction("play"),t.rate&&this.playbackRate(t.rate),t.position?void 0!==t.position.numTrack&&t.position.numTrack!=this.options.playlistCurrentItem?e.playlistItemLoad(t.position.numTrack,function(){t.position.time&&e.position(t.position.time/1e3),e.$element[e.options.engine]("play")}):(t.position.time&&e.position(t.position.time/1e3),e.$element[e.options.engine]("play")):e.$element[e.options.engine]("play")):e.$element[e.options.engine]("play")},playbackRate:function(t){if(void 0===t||""==t)return this.$element[this.options.engine]("playbackRate");this.options.playbackRate=t,this.$element[this.options.engine]("playbackRate",t)},playlistItemLoad:function(e,o){if(!this.playlistItemLoading){var n=this;n.playlistItemLoading=!0,console.log("playlistItemLoad",e,this.options.playlist[e]),this.options.playlist[e].url?t.getJSON(this.options.playlist[e].url,{},function(t){if(console.log("playlistItemLoad muxed result",t),t.success&&t.objects.muxedPlayItems&&t.objects.muxedPlayItems[0]){n.options.playlistCurrentItem=e;var i=JSON.parse(t.objects.muxedPlayItems[0]);i.src=i.fileConnectionInfo.video,i.fileConnectionInfo.metadata&&(i.metadata=i.fileConnectionInfo.metadata),n.options.playlist[e]=i,n.src(n.options.playlist[n.options.playlistCurrentItem])}o&&o()}).always(function(){n.playlistItemLoading=!1}):this.options.playlist[e]?(this.options.playlistCurrentItem=e,this.src(this.options.playlist[this.options.playlistCurrentItem]),n.playlistItemLoading=!1,o&&o()):(console.error("Undefined playlist item index "+e),n.playlistItemLoading=!1)}},position:function(t){if(void 0===t||""==t)return this.$element[this.options.engine]("position");this.$element[this.options.engine]("position",t)},ptz:function(e){console.log("m7Player.ptz",e),e?(this.$ptzLayer||(this.$element.find(".m7PlayerPtz").remove(),this.$ptzLayer=t("<div>").addClass("m7PlayerPtz glass-layer").css({"z-index":10}),this.$ptzLayer.appendTo(this.$element),this.$ptzLayer.m7PlayerPtz({})),e.ptzNode&&this.$ptzLayer.m7PlayerPtz("ptzNode",e.ptzNode),this.$ptzLayer.m7PlayerPtz("active",!0)):!1===e&&this.$ptzLayer&&(this.$ptzLayer.m7PlayerPtz("active",!1),this.$ptzLayer.remove(),delete this.$ptzLayer)},requestStreamInfo:function(){this.$element[this.options.engine]("requestStreamInfo")},resizePlayer:function(t,e){console.log("resizePlayer",t,e),this.$element.css({width:t,height:e}),this.$element.trigger("m7PlayerResize",[t,e])},rewind:function(t){console.log("m7Player rewind",t),this.$element[this.options.engine]("rewind",t),"function"==typeof this.$element.m7PlayerAnalytics&&this.$element.m7PlayerAnalytics("clear")},rewindToEnd:function(){this.delayCorrections++,this.lastRewindToEnd=new Date,this.$element[this.options.engine]("rewindToEnd"),"function"==typeof this.$element.m7PlayerAnalytics&&this.$element.m7PlayerAnalytics("clear")},set:function(t,e){console.log("set",t,e),this.options[t]=e},show:function(){this.$element[this.options.engine]("show")},src:function(t){if(console.log("M7Player.src",t),this.delayStop(),this.clear(),this.state("start"),void 0===t||""==t)return this.$element[this.options.engine]("src");this.options.src=t,"video/mjpeg"==t.mime?this.$element.m7PlayerMjpeg({}).m7PlayerMjpeg("src",t):(this.$element[this.options.engine]({autoplay:this.options.autoplay,cache:this.options.cache,controls:this.options.controls,debugRegim:this.options.debugRegim,delayControl:this.options.delayControl,mode:this.options.mode,playbackRate:this.options.playbackRate,stalledTimeout:this.options.stalledTimeout,workersCount:this.options.workersCount}),this.$element[this.options.engine]("volume",this.options.volume),this.$element[this.options.engine]("mute",this.options.muted),this.options.wrongSocket&&(t.src+="-wrongURL"),this.$element[this.options.engine]("src",t),t.metadata&&this.addMetadata(t.metadata)),this.titleInfo()?this.titleInfo(!0):(console.log("m7PlayerTitleTemp!!!"),this.$elementContainer.m7PlayerTitleTemp({duration:this.options.timeoutToHideChannelName}).m7PlayerTitleTemp("show")),this.$element.trigger("m7PlayerSourceChange",[this.options.src])},state:function(t){if(void 0===t||""==t)return this._state;this._state=t,this.$element.trigger("m7PlayerStateChange",[t])},statistics:function(t){if(void 0===t||""===t)return 1==this.options.statistics;console.log("m7Player statistics",t),this.options.statistics=1==t,this.options.statistics?this.$element.m7PlayerInfo({}).m7PlayerInfo("show"):this.$element.m7PlayerInfo({}).m7PlayerInfo("hide"),this.checkStatistics()},stop:function(t){this.$element[this.options.engine]("stop")},testError:function(t){var e=t||"on demand";this.$element.trigger("m7PlayerError",e)},titleInfo:function(t){this.$elementContainer.m7PlayerTitle({});var e=this.$elementContainer.m7PlayerTitle("state");if(void 0===t||""===t)return e;this.$elementContainer.m7PlayerTitle("state",t)},toggle:function(){"visible"==this.$element.css("visibility")?this.hide():this.show()},toggleAnalytics:function(){this.analytics(!this.options.analytics)},toggleDebugInfo:function(){this.$elementContainer.m7PlayerTechinfo({}).m7PlayerTechinfo("toggle")},toggleFullscreen:function(){console.log("toggleFullscreen",!this.fullscreenState),this.fullscreen(!this.fullscreenState)},toggleMute:function(){this.mute(!this.mute())},togglePlay:function(t){console.log("togglePlay. state = ",this.state()),"play"==this.state()?this.pause({clickedOnPlayer:t}):"pause"==this.state()&&this.play({clickedOnPlayer:t})},volume:function(t){if(void 0===t||""===t)return this.$element[this.options.engine]("volume");this.$element[this.options.engine]("volume",t)},watchdog:function(e){this.options.watchdogTimeout>0&&t(o).m7PlayerWatchdog({maxDelay:this.options.maxDelay,timeout:this.options.watchdogTimeout})},wheelZoom:function(t){var e=(t.originalEvent?t.originalEvent.deltaY||t.originalEvent.wheelDelta||t.originalEvent.detail:0)<0?1.2:.8,o=this.$element.parent().offset(),n=t.originalEvent.pageX-o.left,i=t.originalEvent.pageY-o.top;this.zoom(e,n,i)},zoom:function(e,o,n){var i=this;console.log("zoom",e,o,n);var o=o||this.$elementContainer.width()/2,n=n||this.$elementContainer.height()/2,r=this.$element.width(),a=this.$element.height();if(r*e<this.$elementContainer.width()&&a*e<this.$elementContainer.height())this.fitPlayerToContainer();else{this.draggable(!0),this.scale=Math.round(r*e*100/this.origWidth),this.scale>300&&(this.scale=300,e=this.scale*this.origWidth/(100*r));var s=this.$elementContainer.find(".normalZoom");if(console.log("New zoom",this.scale),this.scale){this.resizePlayer(r*e,a*e),s.length||((s=t("<div>").addClass("ctl normalZoom pointer")).appendTo(this.$elementContainer),s.click(function(t){i.resetZoom(),t.stopPropagation()})),s.html(this.scale+"%"),o-=this.$element.position().left;var l=this.$element.position().left+o*(1-e);this.$element.css("left",l+"px"),n-=this.$element.position().top;var c=this.$element.position().top+n*(1-e);this.$element.css("top",c+"px")}else s.remove()}},zoomCutMode:function(t){if(void 0===t||""===t)return 1==this.options.zoomCutMode;this.options.zoomCutMode=1==t,this.resetZoom()},resetZoom:function(){this.options.zoomCutMode?this.fillContainer():this.fitPlayerToContainer()}},t.fn.m7Player=function(e){t.fn.m7Player.getters=["src","state","playbackRate","getTimeShift","getPlaybackQuality","getBufferInfo","isAudioAvailable","mute","analytics","getSnapshot","debugInfo","titleInfo","statistics","getErrorsCount","volume","getDelay","getLastRewindToEnd","position","getLastErrorMessage","fullscreen","zoomCutMode"];var o=2<=arguments.length?r.call(arguments,1):[];if(void 0===e||"object"===(void 0===e?"undefined":_typeof(e)))return this.each(function(){t.data(this,"plugin-m7Player")||t.data(this,"plugin-m7Player",new i(this,e))});if("string"==typeof e&&"_"!==e[0]&&"init"!==e){if(0!==Array.prototype.slice.call(arguments,1).length||-1===t.inArray(e,t.fn.m7Player.getters))return this.each(function(){var n=t.data(this,"plugin-m7Player");n instanceof i&&"function"==typeof n[e]&&n[e].apply(n,o)});var n=t.data(this[0],"plugin-m7Player");if(n instanceof i&&"function"==typeof n[e])return n[e].apply(n,o)}}}(jQuery,window,document),function(t,e,o,n){function i(e,o){this.$element=t(e),this.workers={},this.processes={},this.options=t.extend({},a,o),this.init()}var r=[].slice,a={workersCount:1,renewTimeout:5e3};i.prototype={init:function(){},addProcess:function(t){if(this.processes[t.processId])return console.log("The process was added previously ",t.processId),void sendLog("The process "+t.processId+" was added previously");var e=this.chooseWorker(t);console.log("Worker choosed id",e);var o=t.processId;this.processes[o]=t,this.processes[o].workerId=e;var n=this.workers[t.workerType][e];n.processes.push(o),sendLog("addProcess postMessage run",{processId:o,process:this.processes[o],params:[t.processId,t.paramsToWorker],worker:n.worker,workerItem:n}),n.worker.postMessage({cmd:"run",id:o,params:t.paramsToWorker})},chooseWorker:function(t){if("object"==_typeof(this.workers[t.workerType])&&Object.keys(this.workers[t.workerType]).length>0){if(Object.keys(this.workers[t.workerType]).length<this.options.workersCount)return this._addWorker(t);var e,o;for(var n in this.workers[t.workerType]){var i=this.workers[t.workerType][n];console.log("chooseWorker worker",i,this.workers),(!e||i.processes.length<e)&&(e=i.processes.length,o=i.workerId)}return o}return this._addWorker(t)},closeWorker:function(t,o){var n=this.workers[t][o];if(n){for(var i=n.processes,r=0,a=0;a<i.length;a++)delete this.processes[i[a]],r++;this.workers[t][o].worker.terminate(),e.URL.revokeObjectURL(this.workers[t][o].workerObjectURL),delete this.workers[t][o],console.log("Worker "+o+" deleted. Processes removed: "+r)}else console.error("Попытка удалить несуществующий воркер!",{workerType:t,workerId:o})},onMessage:function(t){var e=t.data;if("m7WorkerClosed"==e.msg)console.log("Worker closed "+e.workerId),sendLog("Message: worker closed "+e.workerId),this.closeWorker(e.workerType,e.workerId);else if("m7WorkerState"==e.msg)console.log("Worker state ",e),sendLog("Worker state ",e);else{if(!e.id||!this.processes[e.id])return void console.error("Message from unknown process!",e);this.processes[e.id].onMessage(e)}},removeProcess:function(t){if(this.processes&&this.processes[t]&&this.workers&&this.workers[this.processes[t].workerType]){var o=this.workers[this.processes[t].workerType][this.processes[t].workerId];o?(console.log("!! removeProcess",{processId:t,workerItem:o,workers:this.workers,processes:this.processes}),o.worker.postMessage({cmd:"removeProcess",processId:t}),e.URL.revokeObjectURL(t)):console.error("Trying to remove unknown process id=",t)}else console.error("removeProcess error",{processId:t,processes:this.processes,workers:this.workers})},renew:function(t){if(this.processes&&this.processes[t]&&this.workers&&this.workers[this.processes[t].workerType]){var e=this,o=this.workers[this.processes[t].workerType][this.processes[t].workerId];if(o){var n=new Date;o.lastRenewTime=o.lastRenewTime||n,n-o.lastRenewTime>e.options.renewTimeout&&(o.worker.postMessage({cmd:"renew"}),o.lastRenewTime=n)}else console.error("Try to renew unknown worker! processId="+t,this.processes[t])}else console.error("worker renew error",{processId:t,processes:this.processes,workers:this.workers})},_addWorker:function(t){console.log("_addWorker",t);var o=this;"object"!=_typeof(this.workers[t.workerType])&&(this.workers[t.workerType]={});var n=t.workerText;n+="\n\t\t\t\tinit = function (data) {\n\t\t\t\t\tvar t = this;\n\t\t\t\t\tt.workerId = data.workerId;\n\t\t\t\t\tt.workerType = data.workerType;\n\t\t\t\t\tconsole.log('worker init. id=' + t.workerId);\n\t\t\t\t\tt.checkTimeout();\n\t\t\t\t}\n\n\t\t\t\trenew = function () {\n\t\t\t\t\tthis.lastTime = new Date();\n\t\t\t\t\t// console.log('Worker renew ' + t.workerId);\n\t\t\t\t}\n\n\t\t\t\tcheckTimeout = function (base64) {\n\t\t\t\t\tvar t = this;\n\t\t\t\t\tt.lastTime = t.lastTime || new Date();\n\t\t\t\t\tt.timeout = t.timeout || 20000;\n\t\t\t\t\tsetTimeout(function () {\n\t\t\t\t\t\tvar now = new Date();\n\t\t\t\t\t\t//console.log(\"worker checkTimeout\", now - t.lastTime, now, t.lastTime)\n\t\t\t\t\t\tif (now - t.lastTime > t.timeout) {\n\t\t\t\t\t\t\tconsole.log('No renew messages. Closing worker & websocket on timeout.');\n\t\t\t\t\t\t\tpostMessage({\n\t\t\t\t\t\t\t\tmsg: 'm7WorkerClosed',\n\t\t\t\t\t\t\t\tworkerId: t.workerId,\n\t\t\t\t\t\t\t\tworkerType: t.workerType,\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\tif (websockets) {\n\t\t\t\t\t\t\t\tfor (var key in websockets) {\n\t\t\t\t\t\t\t\t\twebsockets[key].close();\n\t\t\t\t\t\t\t\t\tdelete websockets[key];\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tdelete websockets;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tt.close();\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t//console.log('check websockets', websockets);\n\t\t\t\t\t\t\tpostMessage({\n\t\t\t\t\t\t\t\tmsg: 'm7WorkerState',\n\t\t\t\t\t\t\t\tworkerId: t.workerId,\n\t\t\t\t\t\t\t\tworkerType: t.workerType,\n\t\t\t\t\t\t\t\twebsockets: Object.keys(websockets).length,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tt.checkTimeout();\n\t\t\t\t\t\t}\n\t\t\t\t\t}, 3000);\n\t\t\t\t}\t\t\t\t\n\t\t\t";var i=e.URL.createObjectURL(new Blob([n])),r=new Worker(i);r.onmessage=function(t){o.onMessage(t)};var a;do{a=(new Date).getTime()}while(this.workers[t.workerType][a]);return this.workers[t.workerType][a]={workerId:a,worker:r,workerObjectURL:i,processes:[]},r.postMessage({cmd:"init",workerId:a,workerType:t.workerType}),a}},t.fn.m7Workers=function(e){t.fn.m7Workers.getters=["addWorker","chooseWorker"];var o=2<=arguments.length?r.call(arguments,1):[];if(void 0===e||"object"===(void 0===e?"undefined":_typeof(e)))return this.each(function(){t.data(this,"plugin-m7Workers")||t.data(this,"plugin-m7Workers",new i(this,e))});if("string"==typeof e&&"_"!==e[0]&&"init"!==e){if(0!==Array.prototype.slice.call(arguments,1).length||-1===t.inArray(e,t.fn.m7Workers.getters))return this.each(function(){var n=t.data(this,"plugin-m7Workers");n instanceof i&&"function"==typeof n[e]&&n[e].apply(n,o)});var n=t.data(this[0],"plugin-m7Workers");if(n instanceof i&&"function"==typeof n[e])return n[e].apply(n,o)}}}(jQuery,window,document),function(t,e,o,n){function i(n,i){this.options=t.extend({},a,i),this.$element=t(n),t(o).m7Workers({workersCount:this.options.workersCount}),this.$video=this.$element,this.video=this.$element.get(0),e.MediaSource=e.MediaSource||e.WebKitMediaSource,this.init(),this.options.src&&this.src(this.options.src)}var r=[].slice,a={autoplay:!0,src:"",maxBuffer:30,mode:"stable",videoMimeType:'video/mp4; codecs="avc1.42e028"',workersCount:2};i.prototype={init:function(){this.workerText="var websockets = {};\n\t\t\t\tvar timeout = 20000; // 10 сек - максимальная задержка для renew\n\t\t\t\tvar trackId = 'track';\n\t\t\t\tvar t = this;\n\t\t\t\tonmessage = function (e) { \n\t\t\t\t\t//console.log('onmessage in worker', e.data);\n\t\t\t\t\tif (e.data.cmd == 'run') {\n\t\t\t        \ttry {\n\t\t\t        \t\tvar id = e.data.id;\n\t\t\t        \t\tif (!id) {\n\t\t\t        \t\t\tconsole.error('Websocket id is undefined', e.data);\n\t\t\t        \t\t}\n\n\t\t\t\t\t\t\tif (websockets[id]) {\n\t\t\t\t\t\t\t\tconsole.log('try to close websocket');\n\t\t\t\t\t\t\t\twebsockets[id].close();\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\twebsockets[id] = new WebSocket(e.data.params.uri);\n\t\t\t\t\t\t\twebsockets[id].binaryType = \"arraybuffer\";\n\t\t\t\t\t\t\twebsockets[id].lastKeepAlive = 0;\n\t\t\t\t\t\t\twebsockets[id].onmessage = function(e) {\n\t\t\t\t\t\t\t\tif (websockets[id].inited) {\n\t\t\t\t\t\t\t\t\tdispatchMessage(id, e.data);\t\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\twebsockets[id].inited = true;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tvar now = new Date();\n\t\t\t\t\t\t\t\t//console.log(now - lastKeepAlive, now - lastKeepAlive > 10000);\n\t\t\t\t\t\t\t\tif (now - websockets[id].lastKeepAlive > 10000) {\n\t\t\t\t\t\t\t\t\tif (WebSocket.OPEN === websockets[id].readyState) {\n                \t\t\t\t\t\twebsockets[id].send('keepAlive');\n            \t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\twebsockets[id].lastKeepAlive = now;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\twebsockets[id].onerror = function(e) {\n\t\t\t\t\t\t\t\tconsole.error({\n\t\t\t\t\t\t\t\t\tmsg: 'websocket error', \n\t\t\t\t\t\t\t\t\tid: id,\n\t\t\t\t\t\t\t\t\tdata: e\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\twebsockets[id].onopen = function(e) {\n\t\t\t\t\t\t\t\t//console.log('worker websocket open', e);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\twebsockets[id].onclose = function(e) {\n\t\t\t\t\t\t\t\t//console.log('worker websocket close', e);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\t\tconsole.error({\n\t\t\t\t\t\t\t\tmsg: 'error', \n\t\t\t\t\t\t\t\tdata: error\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\t\t\t\t\n\t\t\t\t\t} else {\n\t\t\t\t\t\tif (typeof t[e.data.cmd] == 'function') {\n\t\t\t\t\t\t\tt[e.data.cmd](e.data);\n\t\t\t\t\t\t}\t\t\t\t\t\t\n\t\t\t\t\t} \n\t\t\t\t}\n\n\t\t\t\tbase64ToArrayBuffer = function (base64) {\n\t\t\t\t\treturn Uint8Array.from(atob(base64), function(c) {\n\t\t\t\t\t\treturn c.charCodeAt(0);\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tgetRawData = function(a) {\n                \tvar b = (1 === a[0]) ? 0 : 4;\n                \treturn a.subarray(1 + b)                 \n            \t}\n\n\t\t\t\tdispatchMessage = function (id, rawData) {\n\t\t\t\t\t//console.log('worker dispatchMessage', rawData instanceof ArrayBuffer, typeof(rawData));\n\t\t\t\t\t//console.log('_dispatchMessage');\n\t\t\t\t\tif(rawData instanceof ArrayBuffer) {\n\t\t\t\t\t  // 12,4 = mfhd\n\t\t\t\t\t  // 20,4 slice - segment.id\n\t\t\t\t\t  // 36,4 = tfhd\n\t\t\t\t\t  // 44,4 slice - track.id\n\t\t\t\t\t  // 64,4 = tfdt\n\t\t\t\t\t  // 72,8 slice - prestime\n\t\t\t\t\t  // 84,4 = trun\n\t\t\t\t\t  //var view = new Uint8Array(rawData);\n\t\t\t\t\t  //t._appendData(view[47], view);\n\t\t\t\t\t  var res = getRawData(new Uint8Array(rawData));\n\t\t\t\t\t  appendData(id, trackId, res);\n\t\t\t\t\t} else {\n\t\t\t\t\t  var data = JSON.parse(rawData);\n\t\t\t\t\t  console.log('JSON received', data);\n\t\t\t\t\t  \n\t\t\t\t\t  if (data.streamMeta) {\n\t\t\t\t\t\t//console.log('streamMeta received', data);\n\t\t\t\t\t\tpostMessage({\n\t\t\t\t\t\t\tid: id,\n\t\t\t\t\t\t\tmsg: 'm7MetadataReceived',\n\t\t\t\t\t\t\ttimestamp: data.timestamp,\n\t\t\t\t\t\t\tstreamMeta: data.streamMeta\t\t\t\t\t\t\t\n\t\t\t\t\t\t});\n\t\t\t\t\t  }\n\t\t\t\t\t  if (data.type === 'mse_init_segment') {\n\t\t\t\t\t  \tdata.id = trackId;\n\t\t\t\t\t\tpostMessage({\n\t\t\t\t\t\t\tid: id,\n\t\t\t\t\t\t\tmsg: 'm7StreamTimeShiftReceived',\n\t\t\t\t\t\t\tcorrection: data.correction\n\t\t\t\t\t\t});\n\t\t\t\t\t  }\n\t\t\t\t\t}\t\t\t\t\t\n\t\t\t\t}\n\n\t\t\t\tappendData = function (id, trackId, arrayBuffer) {\n\t\t\t\t\tpostMessage({\n\t\t\t\t\t\tid: id,\n\t\t\t\t\t\tmsg: 'appendData', \n\t\t\t\t\t\ttrackId: trackId,\n\t\t\t\t\t\tarrayBuffer: arrayBuffer\n\t\t\t\t\t});\n\t\t\t\t}"},src:function(n){var i=this;console.log("synologyMSE.src",n),this.counters={updatestart:0,update:0,updateend:0,error:0,abort:0,appendData:0,updatingOnUpdate:0,updatingOnAppendData:0},this.mediaSource&&(this.init(),"open"==this.mediaSource.readyState&&this.mediaSource.endOfStream()),this.buffers={},this.queues={},this.mediaSource=new MediaSource,this.video.src=e.URL.createObjectURL(i.mediaSource),this.mediaSource.addEventListener("sourceopen",function(e){n.codec&&(i.options.videoMimeType=n.codec),t(o).m7Workers("addProcess",{workerType:"synologyWebsocket",workerText:i.workerText,processId:i.video.src,paramsToWorker:{uri:n.src},onMessage:function(n){"appendData"==n.msg?(i._appendData(n.trackId,n.arrayBuffer),t(o).m7Workers("renew",n.id),sendLog(n.arrayBuffer.length),sendLog(" "+n.arrayBuffer.length+" -3гена- "+arrayBufferToBase64(new Uint8Array(n.arrayBuffer)))):"m7StreamTimeShiftReceived"==n.msg?i.$video.trigger("m7StreamTimeShiftReceived",[n.correction]):"error"==n.msg?i.$video.trigger("error",e):console.error("Unknown answer from worker",n)}})})},_createSourceBuffers:function(t){var e=this;console.log("synologyMSE createSourceBuffers",t);var o=this.options.videoMimeType,n=e.buffers[t.id]=e.mediaSource.addSourceBuffer(o);"debug"==this.options.mode?n.mode="segments":n.mode="sequence";var i=e.queues[t.id]=[];e.$video.trigger("m7PlayerQueueChanged",[0]),n.addEventListener("updatestart",function(){e.counters.updatestart++}),n.addEventListener("update",function(){e.counters.update++,n.updating&&e.counters.updatingOnUpdate++,i.length>0&&!n.updating&&(n.appendBuffer(i.shift()),e.$video.trigger("m7PlayerQueueChanged",[i.length]))}),n.addEventListener("updateend",function(){if(e.counters.updateend++,e.options.maxBuffer&&n.buffered.length){var t=n.buffered.end(n.buffered.length-1)-n.buffered.start(n.buffered.length-1);if(!n.updating&&t>2*e.options.maxBuffer){var o=n.buffered.start(n.buffered.length-1)+t-e.options.maxBuffer;n.remove(0,o)}}}),n.addEventListener("error",function(){e.counters.error++}),n.addEventListener("abort",function(){e.counters.abort++})},_appendData:function(t,e){var o=this;o.counters.appendData++,o.buffers[t]||o._createSourceBuffers({id:t});var n=o.buffers[t],i=o.queues[t];n.updating&&o.counters.updatingOnAppendData++,n.updating||i.length>0?i.length<1e3?i.push(e):console.error("queue length is greater then 1000!"):(o.video.error&&console.error("HTMLMediaElement error ",o.video.error),n.appendBuffer(e)),o.$video.trigger("m7PlayerMseStatus",[o.counters])}},t.fn.synologyMSE=function(e){t.fn.synologyMSE.getters=[];var o=2<=arguments.length?r.call(arguments,1):[];if(void 0===e||"object"===(void 0===e?"undefined":_typeof(e)))return this.each(function(){t.data(this,"plugin-synologyMSE")||t.data(this,"plugin-synologyMSE",new i(this,e))});if("string"==typeof e&&"_"!==e[0]&&"init"!==e){if(0!==Array.prototype.slice.call(arguments,1).length||-1===t.inArray(e,t.fn.synologyMSE.getters))return this.each(function(){var n=t.data(this,"plugin-synologyMSE");n instanceof i&&"function"==typeof n[e]&&n[e].apply(n,o)});var n=t.data(this[0],"plugin-synologyMSE");if(n instanceof i&&"function"==typeof n[e])return n[e].apply(n,o)}}}(jQuery,window,document),function(t,e,o,n){function i(o,n){this.options=t.extend({},s,n),this.$element=t(o),this.$video=this.$element,this.video=this.$element.get(0),e.MediaSource=e.MediaSource||e.WebKitMediaSource,this.init(),this.options.src&&this.src(this.options.src)}var r=[].slice,a="videoMseNoWorkers",s={autoplay:!0,src:"",maxBuffer:30,mode:"stable",videoMimeType:'video/mp4;codecs="avc1.4d401f"'};i.prototype={init:function(){},src:function(t){var o=this;console.log("videoMseNoWorkers.src",t),this.counters={updatestart:0,update:0,updateend:0,error:0,abort:0,appendData:0,updatingOnUpdate:0,updatingOnAppendData:0},o.websocket&&(console.log("try to close websocket"),o.websocket.close()),this.mediaSource&&(this.init(),"open"==this.mediaSource.readyState&&this.mediaSource.endOfStream()),this.buffers={},this.queues={},this.mediaSource=new MediaSource,this.video.src=e.URL.createObjectURL(o.mediaSource),this.mediaSource.addEventListener("sourceopen",function(e){t.codec&&(o.options.videoMimeType=t.codec);try{o.websocket=new WebSocket(t.src),o.websocket.binaryType="arraybuffer",o.websocket.onmessage=function(t){o._dispatchMessage(t.data)},o.websocket.onerror=function(t){console.error("websocket error",t),o.$video.trigger("error",t)},o.websocket.onopen=function(t){console.log("websocket open",t)},o.websocket.onclose=function(t){console.log("websocket close",t)},o.$video.trigger("m7-newWebsocket",[o.websocket])}catch(t){o.$element.trigger("error",t)}})},_createSourceBuffers:function(t){var e=this;console.log("videoMseNoWorkers createSourceBuffers",t);var o=this.options.videoMimeType,n=e.buffers[t.id]=e.mediaSource.addSourceBuffer(o);"debug"==this.options.mode?n.mode="segments":n.mode="sequence";var i=e.queues[t.id]=[];e.$video.trigger("m7PlayerQueueChanged",[0]),n.addEventListener("updatestart",function(){e.counters.updatestart++}),n.addEventListener("update",function(){e.counters.update++,n.updating&&e.counters.updatingOnUpdate++,i.length>0&&!n.updating&&(n.appendBuffer(i.shift()),e.$video.trigger("m7PlayerQueueChanged",[i.length]))}),n.addEventListener("updateend",function(){if(e.counters.updateend++,e.options.maxBuffer&&n.buffered.length){var t=n.buffered.end(n.buffered.length-1)-n.buffered.start(n.buffered.length-1);if(!n.updating&&t>2*e.options.maxBuffer){var o=n.buffered.start(n.buffered.length-1)+t-e.options.maxBuffer;n.remove(0,o)}}}),n.addEventListener("error",function(){e.counters.error++}),n.addEventListener("abort",function(){e.counters.abort++})},_dispatchMessage:function(t){var e=this;if(t instanceof ArrayBuffer){e.buffers.track||e._createSourceBuffers({id:"track"});var o=new Uint8Array(t);e._appendData("track",o)}else{var n=JSON.parse(t);n.streamMeta&&e.$video.trigger("m7MetadataReceived",[n.streamMeta,n.timestamp]),"mse_init_segment"===n.type?(n.id="track",e._createSourceBuffers(n),n.correction&&e.$video.trigger("m7StreamTimeShiftReceived",[n.correction]),n.streamData&&e._appendData("track",e._base64ToArrayBuffer(n.streamData))):"mse_media_segment"===n.type&&n.streamData&&e._appendData("track",e._base64ToArrayBuffer(n.streamData))}},_appendData:function(t,e){var o=this;o.counters.appendData++,o.buffers[t]||o._createSourceBuffers({id:t});var n=o.buffers[t],i=o.queues[t];n.updating&&o.counters.updatingOnAppendData++,n.updating||i.length>0?i.length<500?i.push(e):console.error("queue length is greater then 500!"):(o.video.error&&console.error("HTMLMediaElement error ",o.video.error),n.appendBuffer(e)),o.$video.trigger("m7PlayerMseStatus",[o.counters])}},t.fn[a]=function(e){t.fn[a].getters=[];var o=2<=arguments.length?r.call(arguments,1):[];if(void 0===e||"object"===(void 0===e?"undefined":_typeof(e)))return this.each(function(){t.data(this,"plugin-"+a)||t.data(this,"plugin-"+a,new i(this,e))});if("string"==typeof e&&"_"!==e[0]&&"init"!==e){if(0!==Array.prototype.slice.call(arguments,1).length||-1===t.inArray(e,t.fn[a].getters))return this.each(function(){var n=t.data(this,"plugin-"+a);n instanceof i&&"function"==typeof n[e]&&n[e].apply(n,o)});var n=t.data(this[0],"plugin-"+a);if(n instanceof i&&"function"==typeof n[e])return n[e].apply(n,o)}}}(jQuery,window,document),function(t,e,o,n){function i(o,n){this.options=t.extend({},s,n),this.$element=t(o),this.$video=this.$element,this.video=this.$element.get(0),e.MediaSource=e.MediaSource||e.WebKitMediaSource,this.init(),this.options.src&&this.src(this.options.src)}var r=[].slice,a="videoMseNoWorkers2",s={autoplay:!0,src:"",maxBuffer:30,minBufferSizeToAppend:1e4,mode:"stable",videoMimeType:'video/mp4;codecs="avc1.4d401f"'};i.prototype={init:function(){},src:function(t){var o=this;console.log("videoMseNoWorkers2.src",t),this.counters={updatestart:0,update:0,updateend:0,error:0,abort:0,appendData:0,updatingOnUpdate:0,updatingOnAppendData:0},o.websocket&&(console.log("try to close websocket"),o.websocket.close()),this.mediaSource&&(this.init(),"open"==this.mediaSource.readyState&&this.mediaSource.endOfStream()),this.buffers={},this.queues={},this.mediaSource=new MediaSource,this.video.src=e.URL.createObjectURL(o.mediaSource),this.mediaSource.addEventListener("sourceopen",function(e){t.codec&&(o.options.videoMimeType=t.codec);try{o.websocket=new WebSocket(t.src),o.websocket.binaryType="arraybuffer",o.cache=new ArrayBuffer,o.websocket.onmessage=function(t){o._dispatchMessage(t.data)},o.websocket.onerror=function(t){console.error("websocket error",t),o.$video.trigger("error",t)},o.websocket.onopen=function(t){console.log("websocket open",t)},o.websocket.onclose=function(t){console.log("websocket close",t)},o.$video.trigger("m7-newWebsocket",[o.websocket])}catch(t){o.$element.trigger("error",t)}})},_createSourceBuffers:function(t){var e=this;console.log("videoMseNoWorkers2 createSourceBuffers",t);var o=this.options.videoMimeType,n=e.buffers[t.id]=e.mediaSource.addSourceBuffer(o);"debug"==this.options.mode?n.mode="segments":n.mode="sequence";var i=e.queues[t.id]=[];e.$video.trigger("m7PlayerQueueChanged",[0]),n.addEventListener("updatestart",function(){e.counters.updatestart++}),n.addEventListener("update",function(){e.counters.update++,n.updating&&e.counters.updatingOnUpdate++,i.length>0&&!n.updating&&(n.appendBuffer(i.shift()),e.$video.trigger("m7PlayerQueueChanged",[i.length]))}),n.addEventListener("updateend",function(){if(e.counters.updateend++,e.options.maxBuffer&&n.buffered.length){var t=n.buffered.end(n.buffered.length-1)-n.buffered.start(n.buffered.length-1);if(!n.updating&&t>2*e.options.maxBuffer){var o=n.buffered.start(n.buffered.length-1)+t-e.options.maxBuffer;n.remove(0,o)}}}),n.addEventListener("error",function(){e.counters.error++}),n.addEventListener("abort",function(){e.counters.abort++})},_dispatchMessage:function(t){var e=this;if(t instanceof ArrayBuffer){e.buffers.track||e._createSourceBuffers({id:"track"});var o=new Uint8Array(e.cache.byteLength+t.byteLength);o.set(new Uint8Array(e.cache),0),o.set(new Uint8Array(t),e.cache.byteLength),e.cache=o.buffer,e.cache.byteLength>=e.options.minBufferSizeToAppend&&(e._appendData("track",e.cache),e.cache=new ArrayBuffer)}else{var n=JSON.parse(t);n.streamMeta&&e.$video.trigger("m7MetadataReceived",[n.streamMeta,n.timestamp]),"mse_init_segment"===n.type?(n.id="track",e._createSourceBuffers(n),n.correction&&e.$video.trigger("m7StreamTimeShiftReceived",[n.correction]),n.streamData&&e._appendData("track",e._base64ToArrayBuffer(n.streamData))):"mse_media_segment"===n.type&&n.streamData&&e._appendData("track",e._base64ToArrayBuffer(n.streamData))}},_appendData:function(t,e){var o=this;o.counters.appendData++,o.buffers[t]||o._createSourceBuffers({id:t});var n=o.buffers[t],i=o.queues[t];n.updating&&o.counters.updatingOnAppendData++,n.updating||i.length>0?i.length<500?i.push(e):console.error("queue length is greater then 500!"):(o.video.error&&console.error("HTMLMediaElement error ",o.video.error),n.appendBuffer(e)),o.$video.trigger("m7PlayerMseStatus",[o.counters])}},t.fn[a]=function(e){t.fn[a].getters=[];var o=2<=arguments.length?r.call(arguments,1):[];if(void 0===e||"object"===(void 0===e?"undefined":_typeof(e)))return this.each(function(){t.data(this,"plugin-"+a)||t.data(this,"plugin-"+a,new i(this,e))});if("string"==typeof e&&"_"!==e[0]&&"init"!==e){if(0!==Array.prototype.slice.call(arguments,1).length||-1===t.inArray(e,t.fn[a].getters))return this.each(function(){var n=t.data(this,"plugin-"+a);n instanceof i&&"function"==typeof n[e]&&n[e].apply(n,o)});var n=t.data(this[0],"plugin-"+a);if(n instanceof i&&"function"==typeof n[e])return n[e].apply(n,o)}}}(jQuery,window,document),function(t,o,n,i){function r(e,i){this.options=t.extend({},s,i),this.$element=t(e),this.$video=this.$element,this.video=this.$element.get(0),console.log("videoMSE regim!");var r=this;this.$element.closest(".m7Player").on("m7PlayerError",function(){console.log("VideoMSE: on m7PlayerError. Trying to remove socket ",r.objectURL),r.objectURL&&t(n).m7Workers("removeProcess",r.objectURL)}),t(n).m7Workers({workersCount:this.options.workersCount}),o.MediaSource=o.MediaSource||o.WebKitMediaSource,this.init(),this.options.src&&this.src(this.options.src)}var a=[].slice,s={autoplay:!0,cache:0,src:"",maxBuffer:5,mode:"stable",videoMimeType:'video/mp4;codecs="avc1.4d401f"',workersCount:1};r.prototype={init:function(){var t=this;t.lastRenew=0,t.workerText="var websockets = {};\n\t\t\t\tvar timeout = 20000; // мс, максимальная задержка для worker renew\n\t\t\t\t//var timeoutProcess = 10000; // мс, максимальная задержка для получения сообщений от процесса (сокета)\n\t\t\t\tvar minBufferSizeToAppend; // байт, делаем свой собственный кэш буфера для решения проблемы затыка браузера при большом числе мелких пакетов\n\t\t\t\tvar trackId = 'track';\t\t\t\t\n\t\t\t\tvar t = this;\n\t\t\t\tonmessage = function (e) { \n\t\t\t\t\t//console.log('onmessage in worker', e.data);\n\t\t\t\t\tif (e.data.cmd == 'run') {\n\t\t\t\t\t\tthis.addProcess(e.data);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tif (typeof t[e.data.cmd] == 'function') {\n\t\t\t\t\t\t\tt[e.data.cmd](e.data);\n\t\t\t\t\t\t}\t\t\t\t\t\t\n\t\t\t\t\t} \n\t\t\t\t\tdelete e;\n\t\t\t\t}\n\n\t\t\t\taddProcess = function (data) {\n\t\t        \ttry {\n\t\t        \t\tvar id = data.id;\n\t\t        \t\tif (!id) {\n\t\t        \t\t\tconsole.error('Websocket id is undefined', data);\n\t\t        \t\t}\n\n\t\t\t\t\t\tif (websockets[id]) {\n\t\t        \t\t\tthis.removeProcess(id); // на всякий\n\t\t        \t\t}\n\n\t\t        \t\tconsole.log('websocket run', data);\n\t\t\t\t\t\twebsockets[id] = {};\n\t\t\t\t\t\twebsockets[id].video = new WebSocket(data.params.uri);\n\t\t\t\t\t\tminBufferSizeToAppend = data.params.cache;\n\t\t\t\t\t\tconsole.log('worker cache', minBufferSizeToAppend);\n\t\t\t\t\t\twebsockets[id].video.binaryType = \"arraybuffer\";\n\t\t\t\t\t\twebsockets[id].video.cache = new ArrayBuffer();\n\t\t\t\t\t\twebsockets[id].video.lastKeepAlive = 0;\n\t\t\t\t\t\twebsockets[id].video.onmessage = function(e) {\n\t\t\t\t\t\t\t//console.log('websocket.onmessage', e.data);\n\t\t\t\t\t\t\tdispatchMessage(id, websockets[id].video, e.data);\n\n\t\t\t\t\t\t\tvar now = new Date();\n\t\t\t\t\t\t\t//console.log(now - lastKeepAlive, now - lastKeepAlive > 10000);\n\t\t\t\t\t\t\tif (now - websockets[id].video.lastKeepAlive > 10000) {\n\t\t\t\t\t\t\t\tif (WebSocket.OPEN === websockets[id].video.readyState) {\n            \t\t\t\t\t\twebsockets[id].video.send('keepAlive');\n        \t\t\t\t\t\t}\n\t\t\t\t\t\t\t\twebsockets[id].video.lastKeepAlive = now;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\twebsockets[id].video.onerror = function(e) {\n\t\t\t\t\t\t\tconsole.error({\n\t\t\t\t\t\t\t\tmsg: 'video-mse websocket error', \n\t\t\t\t\t\t\t\tid: id,\n\t\t\t\t\t\t\t\tdata: e\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\twebsockets[id].video.onopen = function(e) {\n\t\t\t\t\t\t\tconsole.log('worker video websocket open', id, e);\n\t\t\t\t\t\t}\n\t\t\t\t\t\twebsockets[id].video.onclose = function(e) {\n\t\t\t\t\t\t\tconsole.log('worker video websocket close', id, e);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (data.params.metadata && data.params.metadata.uri) {\n\t\t\t\t\t\t\twebsockets[id].meta = new WebSocket(data.params.metadata.uri);\n\t\t\t\t\t\t\twebsockets[id].meta.lastKeepAlive = 0;\n\t\t\t\t\t\t\twebsockets[id].meta.onmessage = function(e) {\n\t\t\t\t\t\t\t\t//console.log('websocket.onmessage', e.data);\n\t\t\t\t\t\t\t\tif (e.data != 'keepAlive') {\n\t\t\t\t\t\t\t\t\tdispatchMessage(id, websockets[id].meta, e.data);\t\n\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t\t\n\n\t\t\t\t\t\t\t\tvar now = new Date();\n\t\t\t\t\t\t\t\t//console.log(now - lastKeepAlive, now - lastKeepAlive > 10000);\n\t\t\t\t\t\t\t\tif (now - websockets[id].meta.lastKeepAlive > 10000) {\n\t\t\t\t\t\t\t\t\tif (WebSocket.OPEN === websockets[id].meta.readyState) {\n                \t\t\t\t\t\twebsockets[id].meta.send('keepAlive');\n            \t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\twebsockets[id].meta.lastKeepAlive = now;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\twebsockets[id].meta.onerror = function(e) {\n\t\t\t\t\t\t\t\tconsole.error({\n\t\t\t\t\t\t\t\t\tmsg: 'meta-websocket error', \n\t\t\t\t\t\t\t\t\tid: id,\n\t\t\t\t\t\t\t\t\tdata: e\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\twebsockets[id].meta.onopen = function(e) {\n\t\t\t\t\t\t\t\tconsole.log('worker meta websocket open', id, e);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\twebsockets[id].meta.onclose = function(e) {\n\t\t\t\t\t\t\t\tconsole.log('worker meta websocket close', id, e);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\t// Проверка поступления регулярных данных\n\t\t\t\t\t\t/*websockets[id].checkIntervalId = setInterval(function () {\n\t\t\t\t\t\t\tvar time = new Date() - (websockets[id].lastRawDataDate || 0);\n\t\t\t\t\t\t\tconsole.log('Websocket checkInterval timeout', time, id);\n\t\t\t\t\t\t\tif (time  > timeoutProcess) {\n\t\t\t\t\t\t\t\tconsole.error('Websocket checkInterval timeout expired', time, id, websockets[id]);\n\t\t\t\t\t\t\t\tpostMessage({\n\t\t\t\t\t\t\t\t\tid: id,\n\t\t\t\t\t\t\t\t\tmsg: 'error',\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}, timeoutProcess/2);*/\n\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\tconsole.error('worker error', {\n\t\t\t\t\t\t\tid: id,\n\t\t\t\t\t\t\tmsg: 'error', \n\t\t\t\t\t\t\tdata: error\n\t\t\t\t\t\t});\n\t\t\t\t\t}\t\t\t\t\n\t\t\t\t}\n\n\t\t\t\tremoveProcess = function (data) {\n\t\t\t\t\tvar id = data.processId;\n\t\t\t\t\tconsole.log('!! worker removeProcess: try to close websocket', id, websockets[id], t.workerId, t.websockets);\n\t\t\t\t\tif (websockets[id]) {\n\t\t\t\t\t\tconsole.log('try to close websocket', id);\n\t\t\t\t\t\t//clearInterval(websockets[id].checkIntervalId);\n\t\t\t\t\t\tif (websockets[id].video) {\n\t\t\t\t\t\t\twebsockets[id].video.close();\t\n\t\t\t\t\t\t}\t\t\t\t\t\t\n\t\t\t\t\t\tif (websockets[id].meta) {\n\t\t\t\t\t\t\twebsockets[id].meta.close();\t\n\t\t\t\t\t\t}\t\t\t\t\t\t\n\t\t\t\t\t\tdelete websockets[id];\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconsole.error('trying to close undefined websocket', id, websockets);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tdispatchMessage = function (id, websocket, rawData) {\n\t\t\t\t\t//console.log('worker dispatchMessage', rawData instanceof ArrayBuffer, typeof(rawData));\n\t\t\t\t\t//console.log('_dispatchMessage');\n\t\t\t\t\tif(rawData instanceof ArrayBuffer) {\n\t\t\t\t\t  // 12,4 = mfhd\n\t\t\t\t\t  // 20,4 slice - segment.id\n\t\t\t\t\t  // 36,4 = tfhd\n\t\t\t\t\t  // 44,4 slice - track.id\n\t\t\t\t\t  // 64,4 = tfdt\n\t\t\t\t\t  // 72,8 slice - prestime\n\t\t\t\t\t  // 84,4 = trun\n\t\t\t\t\t  //var view = new Uint8Array(rawData);\n\t\t\t\t\t  //t._appendData(view[47], view);\n\t\t\t\t\t  websockets[id].lastRawDataDate = new Date();\n\t\t \t\t\t\tvar tmp = new Uint8Array(websocket.cache.byteLength + rawData.byteLength);\n\t\t                tmp.set(new Uint8Array(websocket.cache), 0);\n\t\t                tmp.set(new Uint8Array(rawData), websocket.cache.byteLength);\n\t\t                websocket.cache = tmp;\n\t\t                delete tmp;\n\t\t                //console.log('dispatchMessage', websockets[id].cache.byteLength, rawData.byteLength);\n\t\t                if (websocket.cache.byteLength >= minBufferSizeToAppend) {\n\t\t                \t//console.log('dispatchMessage -append');\n\t\t                \tappendData(id, trackId, new Uint8Array(websocket.cache));\n\t\t                \tdelete websocket.cache;\n\t\t                \twebsocket.cache = new ArrayBuffer();\n\t\t                }\n\t\t                //appendData(id, trackId, rawData);\t\t\t\t  \t  \t\n\t\t\t\t\t} else {\n\t\t\t\t\t  //console.log('JSON received', rawData);\n\t\t\t\t\t  var data = JSON.parse(rawData);\t\t\t\t\t  \n\t\t\t\t\t  \n\t\t\t\t\t  if (data.streamMeta) {\n\t\t\t\t\t\t//console.log('streamMeta received', data);\n\t\t\t\t\t\tpostMessage({\n\t\t\t\t\t\t\tid: id,\n\t\t\t\t\t\t\tmsg: 'm7MetadataReceived',\n\t\t\t\t\t\t\ttimestamp: data.timestamp,\n\t\t\t\t\t\t\tstreamMeta: data.streamMeta\t\t\t\t\t\t\t\n\t\t\t\t\t\t});\n\t\t\t\t\t  }\n\t\t\t\t\t  if (data.type === 'mse_init_segment') {\n\t\t\t\t\t  \tconsole.log('mse_init_segment', data);\n\t\t\t\t\t  \tdata.id = trackId;\n\t\t\t\t\t\tpostMessage({\n\t\t\t\t\t\t\tid: id,\n\t\t\t\t\t\t\tmsg: 'm7StreamTimeShiftReceived',\n\t\t\t\t\t\t\tcorrection: data.correction,\n\t\t\t\t\t\t});\n\t\t\t\t\t  \t/*var hasAudio = data.audio || false;\n\t\t\t\t\t\tpostMessage({\n\t\t\t\t\t\t\tid: id,\n\t\t\t\t\t\t\tmsg: 'm7StreamHasAudioReceived',\n\t\t\t\t\t\t\thasAudio: hasAudio\n\t\t\t\t\t\t});*/\n\t\t\t\t\t  }\n\t\t\t\t\t  delete data;\n\t\t\t\t\t}\t\t\t\t\t\n\t\t\t\t}\n\n\t\t\t\tappendData = function (id, trackId, arrayBuffer) {\n\t\t\t\t\tpostMessage({\n\t\t\t\t\t\tid: id,\n\t\t\t\t\t\tmsg: 'appendData', \n\t\t\t\t\t\ttrackId: trackId,\n\t\t\t\t\t\tarrayBuffer: new Uint8Array(arrayBuffer)\n\t\t\t\t\t});\n\t\t\t\t}"},reset:function(){console.log("videoMSE.reset"),this.counters={updatestart:0,update:0,updateend:0,error:0,abort:0,appendData:0,updatingOnUpdate:0,updatingOnAppendData:0},delete this.buffers,delete this.queues,this.mediaSource&&(this.init(),delete this.mediaSource),this.objectURL&&(t(n).m7Workers("removeProcess",this.objectURL),o.URL.revokeObjectURL(this.objectURL),delete this.objectURL)},src:function(t){var e=this;console.log("videoMSE.src",t),sendLog("videoMSE.src",t,getVideoContainerInfo(e.$video)),this.reset(),this.options.src=t,this.buffers={},this.queues={},this.mediaSource=new MediaSource,this.mediaSource.addEventListener("sourceopen",function(){e._sourceopenAction()}),this.objectURL=o.URL.createObjectURL(this.mediaSource),this.video.src=this.objectURL,console.log("videoMSE new video.src",this.objectURL)},_sourceopenAction:function(){var o=this,i=o.options.src;console.log("videoMSE _sourceopenAction",i,o.objectURL),sendLog("videoMSE _sourceopenAction",o.objectURL,getVideoContainerInfo(o.$video)),i.codec&&(o.options.videoMimeType=i.codec),t(n).m7Workers("addProcess",{workerType:"algontWebsocket",processId:o.video.src,workerText:o.workerText,paramsToWorker:{uri:i.src,metadata:i.metadata,cache:o.options.cache},onMessage:function(i){if(i.id!=o.video.src)return console.error("Message with wrong id",i.id),sendLog("Message with wrong id",{id:i.id,player:getVideoContainerInfo(o.$video)}),void t(n).m7Workers("removeProcess",i.id);if("appendData"==i.msg){o._appendData(i.trackId,i.arrayBuffer);var r=new Date;r-o.lastRenew>5e3&&(o.lastRenew=r,t(n).m7Workers("renew",i.id))}else"m7StreamTimeShiftReceived"==i.msg?o.$video.trigger("m7StreamTimeShiftReceived",[i.correction]):"m7MetadataReceived"==i.msg?(console.log("m7MetadataReceived",i.timestamp),o.$video.trigger("m7MetadataReceived",[i.streamMeta,i.timestamp])):"error"==i.msg?(o.$video.trigger("error",e),sendLog("Error message from worker",i,getVideoContainerInfo(o.$video))):console.error("Unknown answer from worker",i)}})},_createSourceBuffers:function(t){var e=this;console.log("videoMSE createSourceBuffers",t),sendLog("videoMSE createSourceBuffers",t,getVideoContainerInfo(e.$video));var o=this.options.videoMimeType,n=e.buffers[t.id]=e.mediaSource.addSourceBuffer(o);"debug"==this.options.mode?n.mode="segments":n.mode="sequence";var i=e.queues[t.id]=[];e.$video.trigger("m7PlayerQueueChanged",[0]),n.addEventListener("updatestart",function(){e.counters.updatestart++}),n.addEventListener("update",function(){e.counters.update++,n.updating&&e.counters.updatingOnUpdate++}),n.addEventListener("updateend",function(){if(e.counters.updateend++,i.length>0&&!n.updating&&(n.appendBuffer(new Uint8Array(i.shift())),e.$video.trigger("m7PlayerQueueChanged",[i.length])),!n.updating&&e.options.maxBuffer&&n.buffered.length){var t=n.buffered.end(n.buffered.length-1)-n.buffered.start(n.buffered.length-1);if(t>2*e.options.maxBuffer){var o=n.buffered.start(n.buffered.length-1)+t-e.options.maxBuffer;n.remove(0,o)}}}),n.addEventListener("error",function(){e.counters.error++}),n.addEventListener("abort",function(){e.counters.abort++})},_appendData:function(t,e){var o=this;o.counters.appendData++,o.buffers[t]||o._createSourceBuffers({id:t});var n=o.buffers[t],i=o.queues[t];n.updating&&o.counters.updatingOnAppendData++,n.updating||i.length>0?(o.$video.trigger("m7PlayerQueueChanged",[i.length]),i.length<200?i.push(new Uint8Array(e)):(console.error("Queue length is over limit!",o.$video),sendLog("**error Queue length is over limit "+i.length,getVideoContainerInfo(o.$video)),o.$video.trigger("m7PlayerError","Queue length is over limit!"))):o.video.error?(console.error("HTMLMediaElement error ",o.video.error),sendLog("**error HTMLMediaElement error",{msg:o.video.error,player:getVideoContainerInfo(o.$video)}),o.$video.trigger("m7PlayerError","HTMLMediaElement error")):n.appendBuffer(new Uint8Array(e)),o.$video.trigger("m7PlayerMSEStatus",[o.counters])}},t.fn.videoMSE=function(e){t.fn.videoMSE.getters=[];var o=2<=arguments.length?a.call(arguments,1):[];if(void 0===e||"object"===(void 0===e?"undefined":_typeof(e)))return this.each(function(){t.data(this,"plugin-videoMSE")||t.data(this,"plugin-videoMSE",new r(this,e))});if("string"==typeof e&&"_"!==e[0]&&"init"!==e){if(0!==Array.prototype.slice.call(arguments,1).length||-1===t.inArray(e,t.fn.videoMSE.getters))return this.each(function(){var n=t.data(this,"plugin-videoMSE");n instanceof r&&"function"==typeof n[e]&&n[e].apply(n,o)});var n=t.data(this[0],"plugin-videoMSE");if(n instanceof r&&"function"==typeof n[e])return n[e].apply(n,o)}}}(jQuery,window,document),function(t,o,n,i){function r(e,i){this.options=t.extend({},s,i),this.$element=t(e),this.$video=this.$element,this.video=this.$element.get(0),console.log("videoMSE2 regim!"),t(n).m7Workers({workersCount:this.options.workersCount}),o.MediaSource=o.MediaSource||o.WebKitMediaSource,this.init(),this.options.src&&this.src(this.options.src)}var a=[].slice,s={autoplay:!0,cache:0,src:"",maxBuffer:5,mode:"stable",videoMimeType:'video/mp4;codecs="avc1.4d401f"',workersCount:1};r.prototype={init:function(){var t=this;t.lastRenew=0,t.workerText="var websockets = {};\n\t\t\t\tvar timeout = 20000; // мс, максимальная задержка для renew\n\t\t\t\tvar minBufferSizeToAppend; // байт, делаем свой собственный кэш буфера для решения проблемы затыка браузера при большом числе мелких пакетов\n\t\t\t\tvar trackId = 'track';\t\t\t\t\n\t\t\t\tvar t = this;\n\t\t\t\tonmessage = function (e) { \n\t\t\t\t\t//console.log('onmessage in worker', e.data);\n\t\t\t\t\tif (e.data.cmd == 'run') {\n\t\t\t        \ttry {\n\t\t\t        \t\tvar id = e.data.id;\n\t\t\t        \t\tif (!id) {\n\t\t\t        \t\t\tconsole.error('Websocket id is undefined', e.data);\n\t\t\t        \t\t}\n\n\t\t\t\t\t\t\tif (websockets[id]) {\n\t\t\t        \t\t\tthis.removeProcess(id); // на всякий\n\t\t\t        \t\t}\n\n\t\t\t        \t\tconsole.log('websocket run', e.data);\n\t\t\t\t\t\t\twebsockets[id] = {};\n\t\t\t\t\t\t\twebsockets[id].video = new WebSocket(e.data.params.uri);\n\t\t\t\t\t\t\tminBufferSizeToAppend = e.data.params.cache;\n\t\t\t\t\t\t\tconsole.log('worker cache', minBufferSizeToAppend);\n\t\t\t\t\t\t\twebsockets[id].video.binaryType = \"arraybuffer\";\n\t\t\t\t\t\t\twebsockets[id].video.cache = new ArrayBuffer();\n\t\t\t\t\t\t\twebsockets[id].video.onmessage = function(e) {\n\t\t\t\t\t\t\t\t//console.log('websocket.onmessage', e.data);\n\t\t\t\t\t\t\t\tdispatchMessage(id, websockets[id].video, e.data);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\twebsockets[id].video.onerror = function(e) {\n\t\t\t\t\t\t\t\tconsole.error({\n\t\t\t\t\t\t\t\t\tmsg: 'websocket error', \n\t\t\t\t\t\t\t\t\tid: id,\n\t\t\t\t\t\t\t\t\tdata: e\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\twebsockets[id].video.onopen = function(e) {\n\t\t\t\t\t\t\t\t//console.log('worker websocket open', e);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\twebsockets[id].video.onclose = function(e) {\n\t\t\t\t\t\t\t\t//console.log('worker websocket close', e);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tif (e.data.params.metadata && e.data.params.metadata.uri) {\n\t\t\t\t\t\t\t\twebsockets[id].meta = new WebSocket(e.data.params.metadata.uri);\n\t\t\t\t\t\t\t\twebsockets[id].meta.onmessage = function(e) {\n\t\t\t\t\t\t\t\t\t//console.log('websocket.onmessage', e.data);\n\t\t\t\t\t\t\t\t\tdispatchMessage(id, websockets[id].meta, e.data);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\twebsockets[id].meta.onerror = function(e) {\n\t\t\t\t\t\t\t\t\tconsole.error({\n\t\t\t\t\t\t\t\t\t\tmsg: 'meta-websocket error', \n\t\t\t\t\t\t\t\t\t\tid: id,\n\t\t\t\t\t\t\t\t\t\tdata: e\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\twebsockets[id].meta.onopen = function(e) {\n\t\t\t\t\t\t\t\t\t//console.log('worker websocket open', e);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\twebsockets[id].meta.onclose = function(e) {\n\t\t\t\t\t\t\t\t\t//console.log('worker websocket close', e);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\t\tconsole.error('worker error', {\n\t\t\t\t\t\t\t\tid: id,\n\t\t\t\t\t\t\t\tmsg: 'error', \n\t\t\t\t\t\t\t\tdata: error\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\t\t\t\t\n\t\t\t\t\t} else {\n\t\t\t\t\t\tif (typeof t[e.data.cmd] == 'function') {\n\t\t\t\t\t\t\tt[e.data.cmd](e.data);\n\t\t\t\t\t\t}\t\t\t\t\t\t\n\t\t\t\t\t} \n\t\t\t\t\tdelete e;\n\t\t\t\t}\n\n\t\t\t\tremoveProcess = function (data) {\n\t\t\t\t\tvar id = data.processId;\n\t\t\t\t\t//console.log('!! worker removeProcess: try to close websocket', id, t.websockets[id], t.workerId, t.websockets);\n\t\t\t\t\tif (t.websockets[id]) {\n\t\t\t\t\t\tconsole.log('try to close websocket', id);\n\t\t\t\t\t\tif (t.websockets[id].video) {\n\t\t\t\t\t\t\tt.websockets[id].video.close();\t\n\t\t\t\t\t\t}\t\t\t\t\t\t\n\t\t\t\t\t\tif (t.websockets[id].meta) {\n\t\t\t\t\t\t\tt.websockets[id].meta.close();\t\n\t\t\t\t\t\t}\t\t\t\t\t\t\n\t\t\t\t\t\tdelete websockets[id];\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconsole.error('trying to close undefined websocket', id, t.websockets);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tdispatchMessage = function (id, websocket, rawData) {\n\t\t\t\t\t//console.log('worker dispatchMessage', rawData instanceof ArrayBuffer, typeof(rawData));\n\t\t\t\t\t//console.log('_dispatchMessage');\n\t\t\t\t\tif(rawData instanceof ArrayBuffer) {\n\t\t\t\t\t  // 12,4 = mfhd\n\t\t\t\t\t  // 20,4 slice - segment.id\n\t\t\t\t\t  // 36,4 = tfhd\n\t\t\t\t\t  // 44,4 slice - track.id\n\t\t\t\t\t  // 64,4 = tfdt\n\t\t\t\t\t  // 72,8 slice - prestime\n\t\t\t\t\t  // 84,4 = trun\n\t\t\t\t\t  //var view = new Uint8Array(rawData);\n\t\t\t\t\t  //t._appendData(view[47], view);\n\t\t \t\t\t\tvar tmp = new Uint8Array(websocket.cache.byteLength + rawData.byteLength);\n\t\t                tmp.set(new Uint8Array(websocket.cache), 0);\n\t\t                tmp.set(new Uint8Array(rawData), websocket.cache.byteLength);\n\t\t                websocket.cache = tmp;\n\t\t                delete tmp;\n\t\t                //console.log('dispatchMessage', websockets[id].cache.byteLength, rawData.byteLength);\n\t\t                if (websocket.cache.byteLength >= minBufferSizeToAppend) {\n\t\t                \t//console.log('dispatchMessage -append');\n\t\t                \tappendData(id, trackId, new Uint8Array(websocket.cache));\n\t\t                \tdelete websocket.cache;\n\t\t                \twebsocket.cache = new ArrayBuffer();\n\t\t                }\n\t\t                //appendData(id, trackId, rawData);\t\t\t\t  \t  \t\n\t\t\t\t\t} else {\n\t\t\t\t\t  //console.log('JSON received', rawData);\n\t\t\t\t\t  var data = JSON.parse(rawData);\t\t\t\t\t  \n\t\t\t\t\t  \n\t\t\t\t\t  if (data.streamMeta) {\n\t\t\t\t\t\t//console.log('streamMeta received', data);\n\t\t\t\t\t\tpostMessage({\n\t\t\t\t\t\t\tid: id,\n\t\t\t\t\t\t\tmsg: 'm7MetadataReceived',\n\t\t\t\t\t\t\ttimestamp: data.timestamp,\n\t\t\t\t\t\t\tstreamMeta: data.streamMeta\t\t\t\t\t\t\t\n\t\t\t\t\t\t});\n\t\t\t\t\t  }\n\t\t\t\t\t  if (data.type === 'mse_init_segment') {\n\t\t\t\t\t  \tconsole.log('mse_init_segment m7StreamTimeShiftReceived');\n\t\t\t\t\t  \tdata.id = trackId;\n\t\t\t\t\t\tpostMessage({\n\t\t\t\t\t\t\tid: id,\n\t\t\t\t\t\t\tmsg: 'm7StreamTimeShiftReceived',\n\t\t\t\t\t\t\tcorrection: data.correction\n\t\t\t\t\t\t});\n\t\t\t\t\t  }\n\t\t\t\t\t}\t\t\t\t\t\n\t\t\t\t}\n\n\t\t\t\tappendData = function (id, trackId, arrayBuffer) {\n\t\t\t\t\tpostMessage({\n\t\t\t\t\t\tid: id,\n\t\t\t\t\t\tmsg: 'appendData', \n\t\t\t\t\t\ttrackId: trackId,\n\t\t\t\t\t\tarrayBuffer: new Uint8Array(arrayBuffer)\n\t\t\t\t\t});\n\t\t\t\t}"},src:function(t){var e=this;console.log("videoMSE2.src",t),sendLog("videoMSE2.src",t,getVideoContainerInfo(e.$video)),this.counters={updatestart:0,update:0,updateend:0,error:0,abort:0,appendData:0,updatingOnUpdate:0,updatingOnAppendData:0},this.mediaSource&&(this.init(),delete this.mediaSource),delete this.buffers,delete this.queues,this.options.src=t,this.buffers={},this.queues={},this.mediaSource=new MediaSource,this.mediaSource.addEventListener("sourceopen",function(){e._sourceopenAction(e)}),this.objectURL=o.URL.createObjectURL(this.mediaSource),this.video.src=this.objectURL,console.log("videoMSE2 new video.src",this.objectURL)},_sourceopenAction:function(o){var i=o.options.src;console.log("videoMSE2 _sourceopenAction",i,o.objectURL),sendLog("videoMSE2 _sourceopenAction",o.objectURL,getVideoContainerInfo(o.$video)),i.codec&&(o.options.videoMimeType=i.codec),t(n).m7Workers("addProcess",{workerType:"algontWebsocket",processId:o.video.src,workerText:o.workerText,paramsToWorker:{uri:i.src,metadata:i.metadata,cache:o.options.cache},onMessage:function(i){if(i.id!=o.video.src)return console.error("Message with wrong id",i.id),sendLog("Message with wrong id",{id:i.id,player:getVideoContainerInfo(o.$video)}),void t(n).m7Workers("removeProcess",i.id);if("appendData"==i.msg){o._appendData(i.trackId,i.arrayBuffer);var r=new Date;r-o.lastRenew>5e3&&(o.lastRenew=r,t(n).m7Workers("renew",i.id))}else"m7StreamTimeShiftReceived"==i.msg?o.$video.trigger("m7StreamTimeShiftReceived",[i.correction]):"m7MetadataReceived"==i.msg?(console.log("m7MetadataReceived",i.timestamp),o.$video.trigger("m7MetadataReceived",[i.streamMeta,i.timestamp])):"error"==i.msg?(o.$video.trigger("error",e),sendLog("Error message from worker",i,getVideoContainerInfo(o.$video))):console.error("Unknown answer from worker",i)}})},_createSourceBuffers:function(t){var e=this;console.log("videoMSE2 createSourceBuffers",t),sendLog("videoMSE2 createSourceBuffers",t,getVideoContainerInfo(e.$video));var o=this.options.videoMimeType,n=e.buffers[t.id]=e.mediaSource.addSourceBuffer(o);"debug"==this.options.mode?n.mode="segments":n.mode="sequence";var i=e.queues[t.id]=[];e.$video.trigger("m7PlayerQueueChanged",[0]),n.addEventListener("updatestart",function(){e.counters.updatestart++}),n.addEventListener("update",function(){e.counters.update++,n.updating&&e.counters.updatingOnUpdate++}),n.addEventListener("updateend",function(){if(e.counters.updateend++,i.length>0&&!n.updating&&(n.appendBuffer(new Uint8Array(i.shift())),e.$video.trigger("m7PlayerQueueChanged",[i.length])),!n.updating&&e.options.maxBuffer&&n.buffered.length){var t=n.buffered.end(n.buffered.length-1)-n.buffered.start(n.buffered.length-1);if(t>2*e.options.maxBuffer){var o=n.buffered.start(n.buffered.length-1)+t-e.options.maxBuffer;n.remove(0,o)}}}),n.addEventListener("error",function(){e.counters.error++}),n.addEventListener("abort",function(){e.counters.abort++})},_appendData:function(t,e){var o=this;o.counters.appendData++,o.buffers[t]||o._createSourceBuffers({id:t});var n=o.buffers[t],i=o.queues[t];n.updating&&o.counters.updatingOnAppendData++,n.updating||i.length>0?(o.$video.trigger("m7PlayerQueueChanged",[i.length]),i.length<200?i.push(new Uint8Array(e)):(console.error("Queue length is over limit!",o.$video),sendLog("**error Queue length is over limit "+i.length,getVideoContainerInfo(o.$video)),o.$video.trigger("m7PlayerError",{reason:"Queue length is over limit!"}))):(o.video.error&&(console.error("HTMLMediaElement error ",o.video.error),sendLog("**error HTMLMediaElement error",{msg:o.video.error,player:getVideoContainerInfo(o.$video)}),o.$video.trigger("m7PlayerError",{reason:"HTMLMediaElement error"})),n.appendBuffer(new Uint8Array(e))),o.$video.trigger("m7PlayerMSEStatus",[o.counters])}},t.fn.videoMSE2=function(e){t.fn.videoMSE2.getters=[];var o=2<=arguments.length?a.call(arguments,1):[];if(void 0===e||"object"===(void 0===e?"undefined":_typeof(e)))return this.each(function(){t.data(this,"plugin-videoMSE2")||t.data(this,"plugin-videoMSE2",new r(this,e))});if("string"==typeof e&&"_"!==e[0]&&"init"!==e){if(0!==Array.prototype.slice.call(arguments,1).length||-1===t.inArray(e,t.fn.videoMSE2.getters))return this.each(function(){var n=t.data(this,"plugin-videoMSE2");n instanceof r&&"function"==typeof n[e]&&n[e].apply(n,o)});var n=t.data(this[0],"plugin-videoMSE2");if(n instanceof r&&"function"==typeof n[e])return n[e].apply(n,o)}}}(jQuery,window,document),function(t,e,o,n){function i(t,e){}var r=[].slice;i.prototype={init:function(){this.workerText="var websockets = {};\n\t\t\t\tvar timeout = 20000; // мс, максимальная задержка для renew\n\t\t\t\tvar minBufferSizeToAppend = 10000; // байт, делаем свой собственный кэш буфера для решения проблемы затыка браузера при большом числе мелких пакетов\n\t\t\t\tvar trackId = 'track';\t\t\t\t\n\t\t\t\tvar t = this;\n\t\t\t\tonmessage = function (e) { \n\t\t\t\t\tconsole.log('onmessage in worker', e.data);\n\t\t\t\t\tif (e.data.cmd == 'run') {\n\t\t\t        \ttry {\n\t\t\t        \t\tvar id = e.data.id;\n\t\t\t        \t\tif (!id) {\n\t\t\t        \t\t\tconsole.error('Websocket id is undefined', e.data);\n\t\t\t        \t\t}\n\n\t\t\t\t\t\t\tif (websockets[id]) {\n\t\t\t\t\t\t\t\tconsole.log('try to close websocket');\n\t\t\t\t\t\t\t\twebsockets[id].close();\n\t\t\t\t\t\t\t\tdelete websockets[id];\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\twebsockets[id] = new WebSocket(e.data.params.uri);\n\t\t\t\t\t\t\twebsockets[id].binaryType = \"arraybuffer\";\n\t\t\t\t\t\t\twebsockets[id].cache = new ArrayBuffer();\n\t\t\t\t\t\t\twebsockets[id].onmessage = function(e) {\n\t\t\t\t\t\t\t\t//console.log('websocket.onmessage', e.data);\n\t\t\t\t\t\t\t\tdispatchMessage(id, e.data);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\twebsockets[id].onerror = function(e) {\n\t\t\t\t\t\t\t\tconsole.error({\n\t\t\t\t\t\t\t\t\tmsg: 'websocket error', \n\t\t\t\t\t\t\t\t\tid: id,\n\t\t\t\t\t\t\t\t\tdata: e\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\twebsockets[id].onopen = function(e) {\n\t\t\t\t\t\t\t\t//console.log('worker websocket open', e);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\twebsockets[id].onclose = function(e) {\n\t\t\t\t\t\t\t\t//console.log('worker websocket close', e);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\t\tconsole.error('worker error', {\n\t\t\t\t\t\t\t\tid: id,\n\t\t\t\t\t\t\t\tmsg: 'error', \n\t\t\t\t\t\t\t\tdata: error\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\t\t\t\t\n\t\t\t\t\t} else {\n\t\t\t\t\t\tif (typeof t[e.data.cmd] == 'function') {\n\t\t\t\t\t\t\tt[e.data.cmd](e.data);\n\t\t\t\t\t\t}\t\t\t\t\t\t\n\t\t\t\t\t} \n\t\t\t\t}\n\n\t\t\t\tbase64ToArrayBuffer = function (base64) {\n\t\t\t\t\treturn Uint8Array.from(atob(base64), function(c) {\n\t\t\t\t\t\treturn c.charCodeAt(0);\n\t\t\t\t\t});\n\t\t\t\t}\n\n\n\t\t\t\tdispatchMessage = function (id, rawData) {\n\t\t\t\t\t//console.log('worker dispatchMessage', rawData instanceof ArrayBuffer, typeof(rawData));\n\t\t\t\t\t//console.log('_dispatchMessage');\n\t\t\t\t\tif(rawData instanceof ArrayBuffer) {\n\t\t\t\t\t  // 12,4 = mfhd\n\t\t\t\t\t  // 20,4 slice - segment.id\n\t\t\t\t\t  // 36,4 = tfhd\n\t\t\t\t\t  // 44,4 slice - track.id\n\t\t\t\t\t  // 64,4 = tfdt\n\t\t\t\t\t  // 72,8 slice - prestime\n\t\t\t\t\t  // 84,4 = trun\n\t\t\t\t\t  //var view = new Uint8Array(rawData);\n\t\t\t\t\t  //t._appendData(view[47], view);\n\t\t \t\t\t\tvar tmp = new Uint8Array(websockets[id].cache.byteLength + rawData.byteLength);\n\t\t                tmp.set(new Uint8Array(websockets[id].cache), 0);\n\t\t                tmp.set(new Uint8Array(rawData), websockets[id].cache.byteLength);\n\t\t                websockets[id].cache = tmp.buffer;\n\t\t                delete tmp;\n\t\t                //console.log('dispatchMessage', websockets[id].cache.byteLength, rawData.byteLength);\n\t\t                if (websockets[id].cache.byteLength >= minBufferSizeToAppend) {\n\t\t                \t//console.log('dispatchMessage -append');\n\t\t                \tappendData(id, trackId, websockets[id].cache);\n\t\t                \tdelete websockets[id].cache;\n\t\t                \twebsockets[id].cache = new ArrayBuffer();\n\t\t                }\n\t\t                //appendData(id, trackId, rawData);\t\t\t\t  \t  \t\n\t\t\t\t\t} else {\n\t\t\t\t\t  var data = JSON.parse(rawData);\n\t\t\t\t\t  console.log('JSON received', data);\n\t\t\t\t\t  \n\t\t\t\t\t  if (data.streamMeta) {\n\t\t\t\t\t\t//console.log('streamMeta received', data);\n\t\t\t\t\t\tpostMessage({\n\t\t\t\t\t\t\tid: id,\n\t\t\t\t\t\t\tmsg: 'm7MetadataReceived',\n\t\t\t\t\t\t\ttimestamp: data.timestamp,\n\t\t\t\t\t\t\tstreamMeta: data.streamMeta\t\t\t\t\t\t\t\n\t\t\t\t\t\t});\n\t\t\t\t\t  }\n\t\t\t\t\t  if (data.type === 'MSE_init_segment') {\n\t\t\t\t\t  \tdata.id = trackId;\n\t\t\t\t\t\tpostMessage({\n\t\t\t\t\t\t\tid: id,\n\t\t\t\t\t\t\tmsg: 'm7StreamTimeShiftReceived',\n\t\t\t\t\t\t\tcorrection: data.correction\n\t\t\t\t\t\t});\n\t\t\t\t\t  }\n\t\t\t\t\t}\t\t\t\t\t\n\t\t\t\t}\n\n\t\t\t\tappendData = function (id, trackId, arrayBuffer) {\n\t\t\t\t\tpostMessage({\n\t\t\t\t\t\tid: id,\n\t\t\t\t\t\tmsg: 'appendData', \n\t\t\t\t\t\ttrackId: trackId,\n\t\t\t\t\t\tarrayBuffer: arrayBuffer\n\t\t\t\t\t});\n\t\t\t\t}"},src:function(n){var i=this;console.log("videoMSE3.src",n),this.counters={updatestart:0,update:0,updateend:0,error:0,abort:0,appendData:0,updatingOnUpdate:0,updatingOnAppendData:0},this.mediaSource&&(this.init(),"open"==this.mediaSource.readyState&&this.mediaSource.endOfStream()),this.buffers={},this.queues={},this.mediaSource=new MediaSource,this.video.src=e.URL.createObjectURL(i.mediaSource),this.mediaSource.addEventListener("sourceopen",function(e){n.codec&&(i.options.videoMimeType=n.codec),t(o).m7Workers("addProcess",{workerType:"algontWebsocket",workerText:i.workerText,paramsToWorker:{uri:n.src},onMessage:function(n){"appendData"==n.msg?(i._appendData(n.trackId,n.arrayBuffer),t(o).m7Workers("renew",n.id)):"m7StreamTimeShiftReceived"==n.msg?i.$video.trigger("m7StreamTimeShiftReceived",[n.correction]):"error"==n.msg?i.$video.trigger("error",e):console.error("Unknown answer from worker",n)}})})},_createSourceBuffers:function(t){var e=this;console.log("videoMSE3 createSourceBuffers",t);var o=this.options.videoMimeType,n=e.buffers[t.id]=e.mediaSource.addSourceBuffer(o);"debug"==this.options.mode?n.mode="segments":n.mode="sequence";var i=e.queues[t.id]=[];e.$video.trigger("m7PlayerQueueChanged",[0]),n.addEventListener("updatestart",function(){e.counters.updatestart++}),n.addEventListener("update",function(){e.counters.update++,n.updating&&e.counters.updatingOnUpdate++,i.length>0&&!n.updating&&(n.appendBuffer(i.shift()),e.$video.trigger("m7PlayerQueueChanged",[i.length]))}),n.addEventListener("updateend",function(){if(e.counters.updateend++,e.options.maxBuffer&&n.buffered.length){var t=n.buffered.end(n.buffered.length-1)-n.buffered.start(n.buffered.length-1);if(!n.updating&&t>2*e.options.maxBuffer){var o=n.buffered.start(n.buffered.length-1)+t-e.options.maxBuffer;n.remove(0,o)}}}),n.addEventListener("error",function(){e.counters.error++}),n.addEventListener("abort",function(){e.counters.abort++})},_appendData:function(t,e){var o=this;o.counters.appendData++,o.buffers[t]||o._createSourceBuffers({id:t});var n=o.buffers[t],i=o.queues[t];n.updating&&o.counters.updatingOnAppendData++,n.updating||i.length>0?(o.$video.trigger("m7PlayerQueueChanged",[i.length]),i.length<500?i.push(e):(console.error("Queue length is greater then 500!",o.$video),o.$video.trigger("m7PlayerError",{reason:"Queue length is greater then 500!"}))):(o.video.error&&console.error("HTMLMediaElement error ",o.video.error),n.appendBuffer(e)),o.$video.trigger("m7PlayerMSEStatus",[o.counters])}},t.fn.videoMSE3=function(e){t.fn.videoMSE3.getters=[];var o=2<=arguments.length?r.call(arguments,1):[];if(void 0===e||"object"===(void 0===e?"undefined":_typeof(e)))return this.each(function(){t.data(this,"plugin-videoMSE3")||t.data(this,"plugin-videoMSE3",new i(this,e))});if("string"==typeof e&&"_"!==e[0]&&"init"!==e){if(0!==Array.prototype.slice.call(arguments,1).length||-1===t.inArray(e,t.fn.videoMSE3.getters))return this.each(function(){var n=t.data(this,"plugin-videoMSE3");n instanceof i&&"function"==typeof n[e]&&n[e].apply(n,o)});var n=t.data(this[0],"plugin-videoMSE3");if(n instanceof i&&"function"==typeof n[e])return n[e].apply(n,o)}}}(jQuery,window,document);